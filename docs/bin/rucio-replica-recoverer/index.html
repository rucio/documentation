<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Running rucio-replica-recoverer · Rucio Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="```"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Running rucio-replica-recoverer · Rucio Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://rucio.github.io/documentation/"/><meta property="og:description" content="```"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/documentation/img/android-chrome-512x512.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="/documentation/css/custom.css"/><link rel="stylesheet" href="/documentation/prism/prism.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&amp;display=swap"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:400,500,700&amp;display=swap"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code&amp;display=swap"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/documentation/prism/prism.js"></script><script src="/documentation/js/scrollSpy.js"></script><link rel="stylesheet" href="/documentation/css/main.css"/><script src="/documentation/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/documentation/"><img class="logo" src="/documentation/img/wide_logo2.png" alt="Rucio Documentation"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/documentation/docs/" target="_self">Docs</a></li><li class=""><a href="https://rucio.readthedocs.io/_/downloads/en/next/pdf/" target="_self">Downloads</a></li><li class=""><a href="https://arxiv.org/abs/1902.09857" target="_self">Scientific articles</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Ask me something" title="Ask me something"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Running rucio-replica-recoverer</h1></header><article><div><span><pre><code class="hljs"><span class="hljs-symbol">usage:</span> rucio-replica-recoverer [-h] [--nattempts NATTEMPTS]
                               [--younger-than YOUNGER_THAN]
                               [--rse-expression RSE_EXPRESSION]
                               [--vos VOS [VOS ...]] [--run-once]
                               [--max-replicas-per-rse MAX_REPLICAS_PER_RSE]

Replica-Recoverer is a daemon that declares suspicious replicas that are
available on other RSE as bad. Consequently, automatic replica recovery is
triggered via necromancer daemon, which creates a rule <span class="hljs-keyword">for</span> such bad replicas.

optional <span class="hljs-symbol">arguments:</span>
  -h, --help            show this help message <span class="hljs-keyword">and</span> exit
  --nattempts NATTEMPTS
                        Minimum count of suspicious file replica appearance <span class="hljs-keyword">in</span>
                        bad_replicas table.Default value is <span class="hljs-number">10</span>.
  --younger-than YOUNGER_THAN
                        Consider all file replicas logged <span class="hljs-keyword">in</span> bad_replicas
                        table since speicified number of younger-than. Default
                        value is <span class="hljs-number">3</span>.
  --rse-expression RSE_EXPRESSION
                        The RSE on which the recovery should be happening.
  --vos VOS [VOS ...]   Optional list of VOs to consider. Only used <span class="hljs-keyword">in</span> multi-
                        VO mode.
  --run-once            One iteration only.
  --max-replicas-per-rse MAX_REPLICAS_PER_RSE
                        The maximum number of suspicious replicas found on an
                        RSE which may be declared bad. If a higher count is
                        found, no action is be taken.

Preparing RSEs <span class="hljs-keyword">and</span> DIDs <span class="hljs-keyword">for</span> testing this daemon from rucio <span class="hljs-symbol">docker:</span>
------------------------------------------------------------------- $ sudo
docker exec -it dev_rucio_1 /bin/bash Adding the RSEs to rucio <span class="hljs-symbol">DB:</span> $ rucio-
admin rse add MOCK_SUSPICIOUS $ rucio-admin rse set-attribute --rse
MOCK_SUSPICIOUS --key backend_type --value file $ rucio-admin rse set-
attribute --rse MOCK_SUSPICIOUS --key storage_usage_tool --value
<span class="hljs-string">'rucio.rse.protocols.posix.Default.getSpace'</span> $ rucio-admin rse add-protocol
--hostname localhost --scheme file --prefix <span class="hljs-string">'/tmp/rucio_rse1/'</span> --space-token
<span class="hljs-string">'ATLASDATADISK1'</span> --web-service-path <span class="hljs-string">'/srm/managerv2?SFN='</span> --domain-json <span class="hljs-string">'{
"lan": { "read": 1, "write": 1, "delete": 1 }, "wan": { "read": 1, "write": 1,
"delete": 1}}'</span> --impl <span class="hljs-string">'rucio.rse.protocols.posix.Default'</span> MOCK_SUSPICIOUS $
rucio-admin rse info MOCK_SUSPICIOUS $ rucio-admin rse add MOCK_RECOVERY $
rucio-admin rse set-attribute --rse MOCK_RECOVERY --key backend_type --value
POSIX $ rucio-admin rse set-attribute --rse MOCK_RECOVERY --key
storage_usage_tool --value <span class="hljs-string">'rucio.rse.protocols.posix.Default.getSpace'</span> $
rucio-admin rse add-protocol --hostname localhost --scheme file --prefix
<span class="hljs-string">'/tmp/rucio_rse2/'</span> --space-token <span class="hljs-string">'ATLASDATADISK2'</span> --web-service-path
<span class="hljs-string">'/srm/managerv2?SFN='</span> --domain-json <span class="hljs-string">'{ "lan": { "read": 1, "write": 1,
"delete": 1 }, "wan": { "read": 1, "write": 1, "delete": 1}}'</span> --impl
<span class="hljs-string">'rucio.rse.protocols.posix.Default'</span> MOCK_RECOVERY $ rucio-admin rse info
MOCK_RECOVERY For testing, we create the following <span class="hljs-symbol">files:</span>
------------------------------------------------------------------- Name
MOCK_RECOVERY MOCK_SUSPICIOUS BAD (on MOCK_SUSPICIOUS) SUSPICIOUS (on
MOCK_SUSPICIOUS) file_available_suspicious yes yes no yes
file_available_suspicious_and_bad yes yes yes yes file_notavailable_suspicious
unavailable yes no yes Only file_available_suspicious should be the one on
which the daemon takes action <span class="hljs-keyword">and</span> declares it as bad. $ id<span class="hljs-number">0</span>=<span class="hljs-string">`uuidgen`</span> $
id1=<span class="hljs-string">`uuidgen`</span> $ id2=<span class="hljs-string">`uuidgen`</span> $ id3=<span class="hljs-string">`uuidgen`</span> $ echo <span class="hljs-string">"file available on
MOCK_RECOVERY and decalred suspicious on MOCK_SUSPICIOUS (11 times)"</span> &gt;
<span class="hljs-regexp">/tmp/file</span>_available_suspicious<span class="hljs-string">'_'</span>$id1 $ echo <span class="hljs-string">"file available on MOCK_RECOVERY
and declared suspicious on MOCK_SUSPICIOUS (11 times) and 1 time
bad/deleted/lost on MOCK_SUSPICIOUS"</span> &gt;
<span class="hljs-regexp">/tmp/file</span>_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2 $ echo <span class="hljs-string">"file declared as
unavailable on MOCK_RECOVERY and declared as suspicious 11 times on
MOCK_SUSPICIOUS"</span> &gt; <span class="hljs-regexp">/tmp/file</span>_notavailable_suspicious<span class="hljs-string">'_'</span>$id3 Uploading the
files created above to <span class="hljs-symbol">rucio:</span>
------------------------------------------------------------------- rucio add-
dataset <span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0 Added
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas_2ba45524-<span class="hljs-number">860</span>b-<span class="hljs-number">43</span>f9-a601-<span class="hljs-number">6</span>ccec2c46778 $
rucio add-rule <span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0 <span class="hljs-number">1</span> MOCK_SUSPICIOUS $
rucio add-rule --source-replica-expression MOCK_SUSPICIOUS
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0 <span class="hljs-number">1</span> MOCK_RECOVERY $ rucio list-rules
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0 ID ACCOUNT <span class="hljs-symbol">SCOPE:</span>NAME
STATE[OK/REPL/STUCK] RSE_EXPRESSION COPIES EXPIRES (UTC) CREATED (UTC)
-------------------------------- ---------
------------------------------------------------------------------------
---------------------- ---------------- -------- ---------------
------------------- <span class="hljs-number">2</span>a1a078b66ca4e209cc20a5826125334 root
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas_2ba45524-<span class="hljs-number">860</span>b-<span class="hljs-number">43</span>f9-a601-<span class="hljs-number">6</span>ccec2c46778
OK[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>] MOCK_RECOVERY <span class="hljs-number">1</span> <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span><span class="hljs-symbol">:</span><span class="hljs-number">30</span> <span class="hljs-number">8</span>c15d2f8e94a459a86a488055a10d068
root <span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas_2ba45524-<span class="hljs-number">860</span>b-<span class="hljs-number">43</span>f9-a601-<span class="hljs-number">6</span>ccec2c46778
OK[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>] MOCK_SUSPICIOUS <span class="hljs-number">1</span> <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span><span class="hljs-symbol">:</span><span class="hljs-number">28</span> $ rucio upload --scope mock
--rse MOCK_SUSPICIOUS --name file_available_suspicious<span class="hljs-string">'_'</span>$id1
/tmp/file_available_suspicious<span class="hljs-string">'_'</span>$id1 $ rucio upload --scope mock --rse
MOCK_SUSPICIOUS --name file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2
/tmp/file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2 $ rucio upload --scope mock
--rse MOCK_SUSPICIOUS --name file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3
/tmp/file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3 $ rucio upload --scope mock --rse
MOCK_RECOVERY --name file_available_suspicious<span class="hljs-string">'_'</span>$id1
/tmp/file_available_suspicious<span class="hljs-string">'_'</span>$id1 $ rucio upload --scope mock --rse
MOCK_RECOVERY --name file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2
/tmp/file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2 $ rucio upload --scope mock
--rse MOCK_RECOVERY --name file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3
/tmp/file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3 [...] $ rucio attach
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0
<span class="hljs-symbol">mock:</span>file_available_suspicious<span class="hljs-string">'_'</span>$id1 $ rucio attach
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0
<span class="hljs-symbol">mock:</span>file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2 $ rucio attach
<span class="hljs-symbol">mock:</span>dataset_of_suspicious_replicas<span class="hljs-string">'_'</span>$id0
<span class="hljs-symbol">mock:</span>file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3 [...] $ rucio list-file-replicas
<span class="hljs-symbol">mock:</span>file_available_suspicious<span class="hljs-string">'_'</span>$id1 +---------+-----------------------------
-----------------------------------+------------+-----------+-----------------
------------------------------------------------------------------------------
-------------------------------+ <span class="hljs-params">| SCOPE |</span> NAME <span class="hljs-params">| FILESIZE |</span> ADLER32 <span class="hljs-params">| RSE:
REPLICA |</span> <span class="hljs-params">|---------+---------------------------------------------------------
-------+------------+-----------+---------------------------------------------
------------------------------------------------------------------------------
---|</span> <span class="hljs-params">| mock |</span> file_available_suspicious_5180be3e-<span class="hljs-number">4</span>ebc-<span class="hljs-number">4</span>c34-b528-efbfd09f067e <span class="hljs-params">|
87.000 B |</span> <span class="hljs-number">206</span>b1c91 <span class="hljs-params">| MOCK_SUSPICIOUS: file://localhost:0/tmp/rucio_rse1/mock/
1f/6b/file_available_suspicious_5180be3e-4ebc-4c34-b528-efbfd09f067e |</span> <span class="hljs-params">| mock
|</span> file_available_suspicious_5180be3e-<span class="hljs-number">4</span>ebc-<span class="hljs-number">4</span>c34-b528-efbfd09f067e <span class="hljs-params">| 87.000 B |</span>
<span class="hljs-number">206</span>b1c91 <span class="hljs-params">| MOCK_RECOVERY: file://localhost:0/tmp/rucio_rse2/mock/1f/6b/file_av
ailable_suspicious_5180be3e-4ebc-4c34-b528-efbfd09f067e |</span> +---------+---------
-------------------------------------------------------+------------+---------
--+---------------------------------------------------------------------------
---------------------------------------------------+ $ rucio list-file-
replicas <span class="hljs-symbol">mock:</span>file_available_suspicious_and_bad<span class="hljs-string">'_'</span>$id2 +---------+------------
------------------------------------------------------------+------------+----
-------+----------------------------------------------------------------------
----------------------------------------------------------------+ <span class="hljs-params">| SCOPE |</span>
NAME <span class="hljs-params">| FILESIZE |</span> ADLER32 <span class="hljs-params">| RSE: REPLICA |</span> <span class="hljs-params">|---------+------------------------
------------------------------------------------+------------+-----------+----
------------------------------------------------------------------------------
----------------------------------------------------|</span> <span class="hljs-params">| mock |</span>
file_available_suspicious_and_bad_46964411-<span class="hljs-number">95</span>d4-<span class="hljs-number">46</span>c4-a973-<span class="hljs-number">72</span>c045195835 <span class="hljs-params">|
134.000 B |</span> dfdf2bff <span class="hljs-params">| MOCK_SUSPICIOUS: file://localhost:0/tmp/rucio_rse1/mock
/1d/2d/file_available_suspicious_and_bad_46964411-95d4-46c4-a973-72c045195835
|</span> <span class="hljs-params">| mock |</span>
file_available_suspicious_and_bad_46964411-<span class="hljs-number">95</span>d4-<span class="hljs-number">46</span>c4-a973-<span class="hljs-number">72</span>c045195835 <span class="hljs-params">|
134.000 B |</span> dfdf2bff <span class="hljs-params">| MOCK_RECOVERY: file://localhost:0/tmp/rucio_rse2/mock/1
d/2d/file_available_suspicious_and_bad_46964411-95d4-46c4-a973-72c045195835 |</span> 
+---------+-------------------------------------------------------------------
-----+------------+-----------+-----------------------------------------------
------------------------------------------------------------------------------
---------+ $ rucio list-file-replicas <span class="hljs-symbol">mock:</span>file_notavailable_suspicious<span class="hljs-string">'_'</span>$id3
+---------+-------------------------------------------------------------------
+------------+-----------+----------------------------------------------------
-----------------------------------------------------------------------------+
<span class="hljs-params">| SCOPE |</span> NAME <span class="hljs-params">| FILESIZE |</span> ADLER32 <span class="hljs-params">| RSE: REPLICA |</span> <span class="hljs-params">|---------+--------------
-----------------------------------------------------+------------+-----------
+-----------------------------------------------------------------------------
----------------------------------------------------|</span> <span class="hljs-params">| mock |</span>
file_notavailable_suspicious_6157f589-<span class="hljs-number">80</span>db-<span class="hljs-number">492</span>c-acdd-ef5f0c45112f <span class="hljs-params">| 101.000 B
|</span> 0c14223f <span class="hljs-params">| MOCK_SUSPICIOUS: file://localhost:0/tmp/rucio_rse1/mock/7d/a6/fil
e_notavailable_suspicious_6157f589-80db-492c-acdd-ef5f0c45112f |</span> <span class="hljs-params">| mock |</span>
file_notavailable_suspicious_6157f589-<span class="hljs-number">80</span>db-<span class="hljs-number">492</span>c-acdd-ef5f0c45112f <span class="hljs-params">| 101.000 B
|</span> 0c14223f <span class="hljs-params">| MOCK_RECOVERY: file://localhost:0/tmp/rucio_rse2/mock/7d/a6/file_
notavailable_suspicious_6157f589-80db-492c-acdd-ef5f0c45112f |</span> +---------+----
---------------------------------------------------------------+------------+-
----------+-------------------------------------------------------------------
--------------------------------------------------------------+ Modifying the
file statuses <span class="hljs-keyword">in</span> the <span class="hljs-symbol">DB:</span> -------------------------------------- $ python <span class="hljs-comment"># the</span>
paths below point to MOCK_SUSPICIOUS RSE (.../rucio_rse1) $$ file1 = [<span class="hljs-string">'file://
localhost:0/tmp/rucio_rse1/mock/1f/6b/file_available_suspicious_5180be3e-4ebc-
4c34-b528-efbfd09f067e'</span>,] $$ file2 = [<span class="hljs-string">'file://localhost:0/tmp/rucio_rse1/mock/
1d/2d/file_available_suspicious_and_bad_46964411-95d4-46c4-a973-72c045195835'</span>,
] $$ file3 = [<span class="hljs-string">'file://localhost:0/tmp/rucio_rse1/mock/7d/a6/file_notavailable_
suspicious_6157f589-80db-492c-acdd-ef5f0c45112f'</span> ] $$ from
rucio.client.replicaclient import ReplicaClient $$ replica_client =
ReplicaClient() $$ import time $$ <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">11</span>):
replica_client.declare_suspicious_file_replicas(file1, <span class="hljs-string">'This is a good
reason'</span>) replica_client.declare_suspicious_file_replicas(file2, <span class="hljs-string">'This is a
good reason'</span>) replica_client.declare_suspicious_file_replicas(file3, <span class="hljs-string">'This is
a good reason'</span>) time.sleep(<span class="hljs-number">1</span>) <span class="hljs-comment"># Declaring file2 bad on MOCK_SUSPICIOUS:</span>
--------------------------------------- $$
replica_client.declare_bad_file_replicas(file2, <span class="hljs-string">'This is a good reason'</span>) <span class="hljs-comment">#</span>
Update replica state of <span class="hljs-string">'file_notavailable_suspicious'</span><span class="hljs-number">_</span><span class="hljs-string">'$id1'</span> on MOCK_RECOVERY
to <span class="hljs-string">'UNAVAILABLE'</span> <span class="hljs-comment"># (change the file name below according to the info from</span>
rucio !): --------------------------------------------------------------------
--------------------------- $$
replica_client.update_replicas_states(<span class="hljs-string">'MOCK_RECOVERY'</span>, [{<span class="hljs-string">'scope'</span><span class="hljs-symbol">:<span class="hljs-string">'mock'</span></span>,
<span class="hljs-string">'name'</span><span class="hljs-symbol">:<span class="hljs-string">'file_notavailable_suspicious_6157f589-80db-492c-acdd-ef5f0c45112f'</span></span>,
<span class="hljs-string">'state'</span><span class="hljs-symbol">:<span class="hljs-string">'U'</span></span>}]) <span class="hljs-comment"># Checking the results of the file status changes:</span>
------------------------------------------------ $$ from rucio.core.replica
import get_suspicious_files $$ from datetime import datetime, timedelta $$
from_date = datetime.now() - timedelta(days=<span class="hljs-number">3</span>) $$ from rucio.core.replica
import list_bad_replicas_status $$
get_suspicious_files(<span class="hljs-string">'MOCK_SUSPICIOUS'</span>,from_date,<span class="hljs-number">10</span>) [{<span class="hljs-string">'created_at'</span>:
datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>, <span class="hljs-number">12</span>, <span class="hljs-number">56</span>), <span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>, <span class="hljs-string">'cnt'</span>: <span class="hljs-number">11</span>L,
<span class="hljs-string">'name'</span>: u<span class="hljs-string">'file_notavailable_suspicious_6157f589-80db-492c-acdd-ef5f0c45112f'</span>,
<span class="hljs-string">'rse'</span>: u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>}, {<span class="hljs-string">'created_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>,
<span class="hljs-number">12</span>, <span class="hljs-number">48</span>), <span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>, <span class="hljs-string">'cnt'</span>: <span class="hljs-number">11</span>L, <span class="hljs-string">'name'</span>:
u<span class="hljs-string">'file_available_suspicious_5180be3e-4ebc-4c34-b528-efbfd09f067e'</span>, <span class="hljs-string">'rse'</span>:
u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>}] $$ list_bad_replicas_status(rse=<span class="hljs-string">'MOCK_SUSPICIOUS'</span>,
younger_than=from_date) [{<span class="hljs-string">'name'</span>:
u<span class="hljs-string">'file_available_suspicious_and_bad_46964411-95d4-46c4-a973-72c045195835'</span>,
<span class="hljs-string">'rse'</span>: u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>, <span class="hljs-string">'created_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>,
<span class="hljs-number">18</span>, <span class="hljs-number">33</span>), <span class="hljs-string">'updated_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>, <span class="hljs-number">18</span>, <span class="hljs-number">33</span>), <span class="hljs-string">'state'</span>:
BAD, <span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>}] $$ exit() Run the <span class="hljs-symbol">daemon:</span> --------------- $ python
bin/rucio-replica-recoverer --run-once --rse-expression=<span class="hljs-string">'MOCK_SUSPICIOUS'</span>
Terminal <span class="hljs-symbol">output:</span> ---------------- <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">114</span> <span class="hljs-number">709</span> INFO
replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]: ready to query replicas at RSEs like *MOCK*, declared
as suspicious <span class="hljs-keyword">in</span> the last <span class="hljs-number">3</span> days at least <span class="hljs-number">10</span> times <span class="hljs-keyword">and</span> which are available on
other RSEs. <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">124</span> <span class="hljs-number">709</span> INFO replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]:
suspicious replica query took <span class="hljs-number">0</span>.<span class="hljs-number">010151147</span>8424 seconds, total of <span class="hljs-number">1</span> replicas
were found. [{<span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>, <span class="hljs-string">'cnt'</span>: <span class="hljs-number">11</span>L, <span class="hljs-string">'name'</span>:
u<span class="hljs-string">'file_available_suspicious_5180be3e-4ebc-4c34-b528-efbfd09f067e'</span>, <span class="hljs-string">'rse'</span>:
u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>}] <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">125</span> <span class="hljs-number">709</span> INFO replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]:
looking <span class="hljs-keyword">for</span> replica surls. <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">160</span> <span class="hljs-number">709</span> INFO
replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]: found <span class="hljs-number">1</span>/<span class="hljs-number">1</span> surls (took <span class="hljs-number">0</span>.<span class="hljs-number">035572052002</span> seconds) -
declaring them as bad replicas now. <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">160</span> <span class="hljs-number">709</span> INFO
replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]: ready to declare <span class="hljs-number">1</span> bad replica(s) on <span class="hljs-symbol">MOCK_SUSPICIOUS:</span> 
[u<span class="hljs-string">'file://localhost:0/tmp/rucio_rse1/mock/1f/6b/file_available_suspicious_5180
be3e-4ebc-4c34-b528-efbfd09f067e'</span>]. <span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">188</span> <span class="hljs-number">709</span> INFO
replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]: finished declaring bad replicas on MOCK_SUSPICIOUS.
<span class="hljs-number">2019</span>-<span class="hljs-number">02</span>-<span class="hljs-number">19</span> <span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">39</span><span class="hljs-symbol">:</span><span class="hljs-number">24</span>,<span class="hljs-number">192</span> <span class="hljs-number">709</span> INFO replica_recoverer[<span class="hljs-number">0</span>/<span class="hljs-number">0</span>]: graceful stop done <span class="hljs-comment">#</span>
Checking the results of the file status <span class="hljs-symbol">changes:</span>
------------------------------------------------ $ python $$ from
rucio.core.replica import get_suspicious_files $$ from datetime import
datetime, timedelta $$ from_date = datetime.now() - timedelta(days=<span class="hljs-number">3</span>) $$ from
rucio.core.replica import list_bad_replicas_status $$
get_suspicious_files(<span class="hljs-string">'MOCK_SUSPICIOUS'</span>,younger_than=from_date, nattempts=<span class="hljs-number">10</span>,
is_suspicious=True, available_elsewhere=True) &gt;&gt;&gt;
get_suspicious_files(<span class="hljs-string">'MOCK_SUSPICIOUS'</span>,younger_than=from_date, nattempts=<span class="hljs-number">10</span>,
is_suspicious=True, available_elsewhere=True) [] $$
list_bad_replicas_status(rse=<span class="hljs-string">'MOCK_SUSPICIOUS'</span>, younger_than=from_date)
[{<span class="hljs-string">'name'</span>: u<span class="hljs-string">'file_available_suspicious_5180be3e-4ebc-4c34-b528-efbfd09f067e'</span>,
<span class="hljs-string">'rse'</span>: u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>, <span class="hljs-string">'created_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>,
<span class="hljs-number">39</span>, <span class="hljs-number">24</span>), <span class="hljs-string">'updated_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>, <span class="hljs-number">39</span>, <span class="hljs-number">24</span>), <span class="hljs-string">'state'</span>:
BAD, <span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>}, {<span class="hljs-string">'name'</span>:
u<span class="hljs-string">'file_available_suspicious_and_bad_46964411-95d4-46c4-a973-72c045195835'</span>,
<span class="hljs-string">'rse'</span>: u<span class="hljs-string">'MOCK_SUSPICIOUS'</span>, <span class="hljs-string">'created_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>,
<span class="hljs-number">18</span>, <span class="hljs-number">33</span>), <span class="hljs-string">'updated_at'</span>: datetime.datetime(<span class="hljs-number">2019</span>, <span class="hljs-number">2</span>, <span class="hljs-number">19</span>, <span class="hljs-number">14</span>, <span class="hljs-number">18</span>, <span class="hljs-number">33</span>), <span class="hljs-string">'state'</span>:
BAD, <span class="hljs-string">'scope'</span>: u<span class="hljs-string">'mock'</span>}] $$ exit() When run <span class="hljs-keyword">in</span> multi-VO mode, by default the
daemon will run on RSEs from all VOs:: $ rucio-replica-recoverer --run-once
<span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">28</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span>,<span class="hljs-number">151</span> <span class="hljs-number">5461</span> INFO <span class="hljs-symbol">replica_recoverer:</span> This instance will work
on <span class="hljs-symbol">VOs:</span> <span class="hljs-function"><span class="hljs-keyword">def</span>, <span class="hljs-title">abc</span>, <span class="hljs-title">xyz</span>, 123 <span class="hljs-title">By</span> <span class="hljs-title">using</span> <span class="hljs-title">the</span> <span class="hljs-title">`</span><span class="hljs-title">`</span><span class="hljs-title">-</span><span class="hljs-title">-</span><span class="hljs-title">vos</span><span class="hljs-title">`</span><span class="hljs-title">`</span> <span class="hljs-title">argument</span> <span class="hljs-title">only</span> <span class="hljs-title">the</span> <span class="hljs-title">VO</span> <span class="hljs-title">or</span> <span class="hljs-title">VOs</span></span>
specified will be affected:: $ rucio-replica-recoverer --run-once --vos abc
xyz <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">28</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">36</span>,<span class="hljs-number">066</span> <span class="hljs-number">5474</span> INFO <span class="hljs-symbol">replica_recoverer:</span> This instance will
work on <span class="hljs-symbol">VOs:</span> abc, xyz Note that attempting the use the <span class="hljs-string">``</span>--vos<span class="hljs-string">``</span> argument <span class="hljs-keyword">when</span>
<span class="hljs-keyword">in</span> single-VO mode will have no affect:: $ rucio-replica-recoverer --run-once
--vos abc xyz <span class="hljs-number">2020</span>-<span class="hljs-number">07</span>-<span class="hljs-number">28</span> <span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">21</span><span class="hljs-symbol">:</span><span class="hljs-number">33</span>,<span class="hljs-number">349</span> <span class="hljs-number">5488</span> WARNING Ignoring argument vos, this
is only applicable <span class="hljs-keyword">in</span> a multi-VO setup.
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2021 CERN. Created with Docusaurus.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '04e5d623b96121df11ac440e51fc8956',
                indexName: 'rucio-cern',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>