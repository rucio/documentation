<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-operator/suspicious-replica-recoverer" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Suspicious Replica Recoverer | Rucio Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rucio.github.io/documentation/operator/suspicious-replica-recoverer"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Suspicious Replica Recoverer | Rucio Documentation"><meta data-rh="true" name="description" content="Rucio has a daemon that is in charge of handling and recovering suspicious replicas, called the suspicious replica recoverer. A suspicious replica is a file where an attempt to access the file resulted in certain types of error messages. Whether the error was the result of an issue with the file itself or if the problem was caused by something else (e.g. there could have been a problem with the server on which the file is located), is unknown and needs to be taken into account by the suspicious replica recoverer."><meta data-rh="true" property="og:description" content="Rucio has a daemon that is in charge of handling and recovering suspicious replicas, called the suspicious replica recoverer. A suspicious replica is a file where an attempt to access the file resulted in certain types of error messages. Whether the error was the result of an issue with the file itself or if the problem was caused by something else (e.g. there could have been a problem with the server on which the file is located), is unknown and needs to be taken into account by the suspicious replica recoverer."><link data-rh="true" rel="icon" href="/documentation/img/android-chrome-512x512.png"><link data-rh="true" rel="canonical" href="https://rucio.github.io/documentation/operator/suspicious-replica-recoverer"><link data-rh="true" rel="alternate" href="https://rucio.github.io/documentation/operator/suspicious-replica-recoverer" hreflang="en"><link data-rh="true" rel="alternate" href="https://rucio.github.io/documentation/operator/suspicious-replica-recoverer" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://NDP6TP9QYQ-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Rucio Documentation" href="/documentation/opensearch.xml">
<link rel="stylesheet" href="/documentation/css/custom.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:400,500,700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap">
<script src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/documentation/assets/css/styles.ba9ba7c4.css">
<script src="/documentation/assets/js/runtime~main.41ff2dd2.js" defer="defer"></script>
<script src="/documentation/assets/js/main.af7a166a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/documentation/img/rucio_horizontaled_black.svg"><link rel="preload" as="image" href="/documentation/img/rucio_horizontaled_white.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/documentation/"><div class="navbar__logo"><img src="/documentation/img/rucio_horizontaled_black.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/documentation/img/rucio_horizontaled_white.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Rucio Documentation</b></a><a href="/documentation/html/client_api/accountclient.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Python Client API</a><a class="navbar__item navbar__link" href="/documentation/bin/rucio">Command Line Client</a><a href="/documentation/html/rest_api_doc.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">REST API</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Suspicious Replica Recoverer</h1></header><p>Rucio has a daemon that is in charge of handling and recovering suspicious replicas, called the suspicious replica recoverer. A suspicious replica is a file where an attempt to access the file resulted in certain types of error messages. Whether the error was the result of an issue with the file itself or if the problem was caused by something else (e.g. there could have been a problem with the server on which the file is located), is unknown and needs to be taken into account by the suspicious replica recoverer.</p>
<p>An overview of the typical workflow for a replica before it reaches the suspicious replica recoverer can be seen <a href="https://rucio.cern.ch/documentation/started/concepts/replica_workflow/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="suspicious-replicas">Suspicious Replicas<a href="#suspicious-replicas" class="hash-link" aria-label="Direct link to Suspicious Replicas" title="Direct link to Suspicious Replicas">​</a></h2>
<p>Replicas can have various states, two of which are <code>SUSPICIOUS</code> and <code>BAD</code>. Files that are <code>BAD</code> need to either be replaced or removed. The job of the suspicious replica recoverer is to decide how a suspicious replica should be handled.</p>
<p>A replica can be declared suspicious multiple times: each time an attempt to access the replica results in an error message, the replica is declared suspicious. This allows the daemon to handle replicas differently depending on how many times it has been declared suspicious. As long as a file has been declared suspicious less than a certain number of times (referred to as <code>nattempts</code>), it&#x27;s assumed that there is nothing wrong with the replica and that the errors can be ignored. Once there are more that <code>nattempts</code> suspicious declarations, the replica is handled by the daemon.</p>
<p>Before replicas are handled individually, the daemon checks how many suspicious replicas are on each Rucio storage element (RSE), which are the servers that host replicas. If an RSE has more than <code>limit_suspicious_files_on_rse</code> suspicious replicas, then it is assumed that the problem lays with the RSE and not the replicas themselves. Under such a circumstance, the replicas on that RSE are set to the state <code>TEMPORARILY UNAVAILABLE</code> for three days. A replica in this state can&#x27;t be interacted with. The assumption is that after three days, problems with the RSE will have been fixed. If not, then the replicas on that RSE will end up being declared suspicious en masse, which will result in them being set as <code>TEMPORARILY UNAVAILABLE</code> again. This cycle will be repeated until the underlying issue is solved.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="last-remaining-copy-of-a-file">Last remaining copy of a file<a href="#last-remaining-copy-of-a-file" class="hash-link" aria-label="Direct link to Last remaining copy of a file" title="Direct link to Last remaining copy of a file">​</a></h2>
<p>Before any handling of a replica is done, the daemon first checks to see if the replica is the last remaining copy of a file. Specifically, if there is another copy of the replica on a different RSE, then the suspicious replica can safely be declared <code>BAD</code>. If, however, the replica is the last remaining copy, then steps are taken to decide whether or not the replica can be declared <code>BAD</code>:
-<strong>Auditor/checksum</strong>: if the replica was declared <code>SUSPICIOUS</code> by the auditor daemon or if the term <code>checksum</code> appears in the error message that lead to the replica being declared <code>SUSPICIOUS</code>, then the replica is declared <code>BAD</code>.
-<strong>User and log files</strong>: if the replica is for a user or log file, then the replica is declared <code>BAD</code>.
-<strong>Policy</strong>: if a replica survives the first two checks, then the handling of the replica is decided by its associated policy.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replica-policies">Replica policies<a href="#replica-policies" class="hash-link" aria-label="Direct link to Replica policies" title="Direct link to Replica policies">​</a></h2>
<p>A policy defines how a replica is to be handled by the daemon based on the replica&#x27;s datatype and scope. This approach allows for flexibility and specific handling. By default, all replicas are ignored, meaning that if there is no policy specified for the datatype/scope, then no actions are taken on the replica and it will remain untouched.</p>
<p>The current polices are:
-<strong>ignore</strong>: this is the default policy. Datatypes and scopes can be explicitly set to be ignored, which highlights that a decision has purposefully been made to not perform any actions on these replicas. This is done to prevent mistakes in the future.
-<strong>declare bad</strong>: this dictates that any associated datatypes or scopes will be declared <code>BAD</code> by the daemon.
-<strong>dry run</strong>: this policy makes the daemon handle the replicas as if they were to be declared <code>BAD</code>, but at the final step, no actions are taken. This results in log messages with which it becomes possible to see how many replicas of the given datatype/scope would be declared <code>BAD</code> by the daemon.</p>
<p>The replica policies can easily be expanded in the future.</p>
<p>The policies are stored in a JSON file, an example of which can be seen in he following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;action&quot;: &quot;declare bad&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;datatype&quot;: [&quot;HITS&quot;],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;scope&quot;: []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;action&quot;: &quot;ignore&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;datatype&quot;: [&quot;RAW&quot;],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;scope&quot;: []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;action&quot;: &quot;dry run&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;datatype&quot;: [],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;scope&quot;: [&quot;mc.*&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nattempts--1"><code>nattempts = 1</code><a href="#nattempts--1" class="hash-link" aria-label="Direct link to nattempts--1" title="Direct link to nattempts--1">​</a></h2>
<p>A very large number of suspicious replicas have <code>nattempts = 1</code>. To clean up the database, replicas with <code>nattempts = 1</code> that also have a policy that would result in the replica being declared bad are given a &quot;boost&quot;. This means that rules for those replicas are created. These rules only exist to create an attempt to interact with the replica. If there is in fact a problem with the replica (or the RSE), then each rule will result in an error and that replica will be declared <code>SUSPICIOUS</code> once for each rule, which will bring the number of declarations over the <code>nattempts</code> barrier. This results in the replica being handled normally by the daemon during the daemon&#x27;s next cycle.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="passive-and-active-modes">Passive and active modes<a href="#passive-and-active-modes" class="hash-link" aria-label="Direct link to Passive and active modes" title="Direct link to Passive and active modes">​</a></h2>
<p>The suspicious replica recoverer has two modes of operation:</p>
<ul>
<li><strong>Passive (default)</strong>: no actions are taken by the daemon, but log files are generated as if the actions were taken (like a dry-run mode). Useful for testing daemon runs without affecting data.</li>
<li><strong>Active</strong>: the daemon is allowed to take actions on the replicas. This option has to explicitly be set when the daemon is called.</li>
</ul>
<p>A simplified version of the finite state diagram of the daemon can be found below:</p>
<p><img decoding="async" loading="lazy" alt="Suspicious replica recoverer diagram" src="/documentation/assets/images/suspicious_replica_recoverer_diagram-41419d0e06dbd18574b501dbf95c5305.png" width="1360" height="703" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rucio/documentation/tree/main/docs/../docs/operator/suspicious_replica_recoverer.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-03-13T12:05:32.000Z" itemprop="dateModified">Mar 13, 2025</time></b> by <b>Giovanni Guerrieri</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#suspicious-replicas" class="table-of-contents__link toc-highlight">Suspicious Replicas</a></li><li><a href="#last-remaining-copy-of-a-file" class="table-of-contents__link toc-highlight">Last remaining copy of a file</a></li><li><a href="#replica-policies" class="table-of-contents__link toc-highlight">Replica policies</a></li><li><a href="#nattempts--1" class="table-of-contents__link toc-highlight"><code>nattempts = 1</code></a></li><li><a href="#passive-and-active-modes" class="table-of-contents__link toc-highlight">Passive and active modes</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/documentation/img/rucio_horizontaled_black.svg" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/documentation/img/rucio_horizontaled_white.svg" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2023 CERN</div></div></div></footer></div>
</body>
</html>