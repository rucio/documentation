"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[65270],{17689(e,n,i){i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"operator/installing_server","title":"Installing Rucio Server","description":"Prerequisites","source":"@site/../docs/operator/installing_server.md","sourceDirName":"operator","slug":"/operator/installing_server","permalink":"/documentation/operator/installing_server","draft":false,"unlisted":false,"editUrl":"https://github.com/rucio/documentation/tree/main/docs/../docs/operator/installing_server.md","tags":[],"version":"current","lastUpdatedBy":"rdimaio","lastUpdatedAt":1767178147000,"sidebarPosition":3,"frontMatter":{"id":"installing_server","title":"Installing Rucio Server","sidebar_position":3},"sidebar":"docs","previous":{"title":"Setting up Rucio on Kubernetes","permalink":"/documentation/operator/kubernetes"},"next":{"title":"Policy Packages Overview","permalink":"/documentation/operator/policy_packages/policy_packages_overview"}}');var s=i(74848),t=i(28453);const o={id:"installing_server",title:"Installing Rucio Server",sidebar_position:3},c=void 0,l={},a=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Install via pip",id:"install-via-pip",level:2},{value:"Install via Docker",id:"install-via-docker",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"RUCIO_ENABLE_SSL",id:"rucio_enable_ssl",level:3},{value:"RUCIO_SSL_PROTOCOL",id:"rucio_ssl_protocol",level:3},{value:"RUCIO_CA_PATH",id:"rucio_ca_path",level:3},{value:"RUCIO_DEFINE_ALIASES",id:"rucio_define_aliases",level:3},{value:"RUCIO_ENABLE_LOGS",id:"rucio_enable_logs",level:3},{value:"RUCIO_LOG_LEVEL",id:"rucio_log_level",level:3},{value:"RUCIO_LOG_FORMAT",id:"rucio_log_format",level:3},{value:"RUCIO_HOSTNAME",id:"rucio_hostname",level:3},{value:"RUCIO_SERVER_ADMIN",id:"rucio_server_admin",level:3},{value:"RUCIO_CFG configuration parameters",id:"rucio_cfg-configuration-parameters",level:2},{value:"Enable OIDC",id:"enable-oidc",level:2},{value:"Registering OIDC Clients to Identity provider (IdP)",id:"registering-oidc-clients-to-identity-provider-idp",level:3},{value:"Preparing idpsecrets.json",id:"preparing-idpsecretsjson",level:3},{value:"Configuring Rucio Server for OIDC based authentication",id:"configuring-rucio-server-for-oidc-based-authentication",level:3},{value:"Enabling OIDC for Transfers &amp; Deletions",id:"enabling-oidc-for-transfers--deletions",level:3},{value:"Defining <code>&lt;path&gt;</code> for Storage Capabilities:",id:"defining-path-for-storage-capabilities",level:4},{value:"Transfer daemon token flow.",id:"transfer-daemon-token-flow",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsx)(n.p,{children:"The Rucio server runs on Python 2.7, 3.6 and 3.7 on any Unix-like platform."}),"\n",(0,s.jsx)(n.h2,{id:"install-via-pip",children:"Install via pip"}),"\n",(0,s.jsx)(n.p,{children:"Heads up: We recommend to use the docker-based install (see next section) as it\nwill configure many things for you automatically. Only use the pip-based install\nif you have a good reason and know how to configure your webservices manually:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pip install rucio\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will pull the latest release from\n",(0,s.jsx)(n.a,{href:"https://pypi.python.org/pypi/rucio/",children:(0,s.jsx)(n.strong,{children:"PyPi"})}),". The Rucio server also needs\nseveral Python dependencies. These are all listed in the file\n",(0,s.jsx)(n.a,{href:"https://github.com/rucio/rucio/blob/master/requirements/requirements.server.txt",children:(0,s.jsx)(n.code,{children:"requirements.server.txt"})}),"\nand will be pulled in as necessary."]}),"\n",(0,s.jsx)(n.h2,{id:"install-via-docker",children:"Install via Docker"}),"\n",(0,s.jsx)(n.p,{children:"A simple server without SSL can be started like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --name rucio-server --publish 80:80 --detach rucio/rucio-server\n"})}),"\n",(0,s.jsx)(n.p,{children:"This will start up a simple server using sqlite based on an automatically\ngenerated configuration. You can check if the server is running with"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost/ping\n"})}),"\n",(0,s.jsx)(n.p,{children:"This should return the Rucio version used in the container. Any other curl\nrequests will not work as the database backend is not initialized as this image\nis meant to be used with an already bootstrapped database backend. I.e., that\nthe container has to be configured to point to the correct database. There are\ntwo ways to manage the Rucio configuration: using environment variables or by\nmounting a full rucio.cfg."}),"\n",(0,s.jsxs)(n.p,{children:["If you want to set the connection string for the database it can be done using\nthe ",(0,s.jsx)(n.code,{children:"RUCIO_CFG_DATABASE_DEFAULT"})," environment variable, e.g., to start a\ncontainer connecting to a MySQL DB running at ",(0,s.jsx)(n.code,{children:"mysql.db"})," you could use something\nlike this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'docker run --name rucio-server \\\n  --env RUCIO_CFG_DATABASE_DEFAULT="mysql+pymysql://rucio:rucio@mysql.db/rucio" \\\n  --publish 80:80 \\\n  --detach \\\n  rucio/rucio-server\n'})}),"\n",(0,s.jsx)(n.p,{children:"The are much more configuration parameters available that will be listed at the\nend of this readme."}),"\n",(0,s.jsxs)(n.p,{children:["Another way to configure Rucio is to directly mount a complete rucio.cfg into\nthe container. This will then be used instead of the auto-generated one, e.g.,\nif you have a rucio.cfg ready on your host system under ",(0,s.jsx)(n.code,{children:"/tmp/rucio.cfg"})," you\ncould start a container like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --name rucio-server \\\n  --volume /tmp/rucio.cfg:/opt/rucio/etc/rucio.cfg \\\n  --publish 80:80 \\\n  --detach \\\n  rucio/rucio-server\n"})}),"\n",(0,s.jsx)(n.p,{children:"The rucio.cfg is used to configure the database backend."}),"\n",(0,s.jsxs)(n.p,{children:["If you want to enable SSL you would need to set the ",(0,s.jsx)(n.code,{children:"RUCIO_ENABLE_SSL"})," variable\nand also need to include the host certificate, key and the the CA certificate as\nvolumes. E.g.,:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --name rucio-server \\\n  --volume /tmp/ca.pem:/etc/grid-security/ca.pem \\\n  --volume /tmp/hostcert.pem:/etc/grid-security/hostcert.pem \\\n  --volume /tmp/hostkey.pem:/etc/grid-security/hostkey.pem \\\n  --volume /tmp/rucio.cfg:/opt/rucio/etc/rucio.cfg \\\n  --publish 443:443 \\\n  --env RUCIO_ENABLE_SSL=True \\\n  --detach \\\n  rucio/rucio-server\n"})}),"\n",(0,s.jsxs)(n.p,{children:["By default the output of the Apache web server is written directly to stdout and\nstderr. If you would rather direct them into separate files it can be done using\nthe ",(0,s.jsx)(n.code,{children:"RUCIO_ENABLE_LOGS"})," variable. The storage folder of the logs can be used as\na volume:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --name rucio-server \\\n  --volume /tmp/rucio.cfg:/opt/rucio/etc/rucio.cfg \\\n  --volume /tmp/logs:/var/log/httpd \\\n  --publish 80:80 \\\n  --env RUCIO_ENABLE_LOGS=True \\\n  --detach \\\n  rucio/rucio-server\n"})}),"\n",(0,s.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,s.jsxs)(n.p,{children:["As shown in the examples above the rucio-server image can be configured using\nenvironment variables that are passed with ",(0,s.jsx)(n.code,{children:"docker run"}),". Below is a list of all\navailable variables and their behavior:"]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_enable_ssl",children:"RUCIO_ENABLE_SSL"}),"\n",(0,s.jsxs)(n.p,{children:["By default, the Rucio server runs without SSL on port 80. If you want to enable\nSSL set this variable to ",(0,s.jsx)(n.code,{children:"True"}),". If you enable SSL you will also have to provide\nthe host certificate and key and the certificate authority file. The server will\nlook for ",(0,s.jsx)(n.code,{children:"hostcert.pem"}),", ",(0,s.jsx)(n.code,{children:"hostkey.pem"})," and ",(0,s.jsx)(n.code,{children:"ca.pem"})," under ",(0,s.jsx)(n.code,{children:"/etc/grid-security"}),"\nso you will have to mount them as volumes. Furthermore you will also have to\nexpose port 443."]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_ssl_protocol",children:"RUCIO_SSL_PROTOCOL"}),"\n",(0,s.jsx)(n.p,{children:"By default, the server will only accept TLSv1.2 connections. Defining this\nenvironment variable will allow specification of a custom Apache SSLProtocol."}),"\n",(0,s.jsx)(n.h3,{id:"rucio_ca_path",children:"RUCIO_CA_PATH"}),"\n",(0,s.jsxs)(n.p,{children:["If you are using SSL and want use ",(0,s.jsx)(n.code,{children:"SSLCACertificatePath"})," and\n",(0,s.jsx)(n.code,{children:"SSLCARevocationPath"})," you can do so by specifying the path in this variable."]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_define_aliases",children:"RUCIO_DEFINE_ALIASES"}),"\n",(0,s.jsxs)(n.p,{children:["By default, the web server is configured with all common rest endpoints except\nthe authentication endpoint. If you want to specify your own set of aliases you\ncan set this variable to ",(0,s.jsx)(n.code,{children:"True"}),". The web server then expects an alias file under\n",(0,s.jsx)(n.code,{children:"/opt/rucio/etc/aliases.conf"})]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_enable_logs",children:"RUCIO_ENABLE_LOGS"}),"\n",(0,s.jsxs)(n.p,{children:["By default, the log output of the web server is written to stdout and stderr. If\nyou set this variable to ",(0,s.jsx)(n.code,{children:"True"})," the output will be written to ",(0,s.jsx)(n.code,{children:"access_log"})," and\n",(0,s.jsx)(n.code,{children:"error_log"})," under ",(0,s.jsx)(n.code,{children:"/var/log/httpd"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_log_level",children:"RUCIO_LOG_LEVEL"}),"\n",(0,s.jsxs)(n.p,{children:["The default log level is ",(0,s.jsx)(n.code,{children:"info"}),". You can change it using this\nvariable."]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_log_format",children:"RUCIO_LOG_FORMAT"}),"\n",(0,s.jsxs)(n.p,{children:["The default Rucio log format is\n",(0,s.jsx)(n.code,{children:'%ht%tt%{X-Rucio-Forwarded-For}it%Tt%Dt\\"%{X-Rucio-Auth-Token}i\\"t%{X-Rucio-RequestId}it%{X-Rucio-Client-Ref}it\\"%r\\"t%\\>st%b'}),"\nYou can set your own format using this variable."]}),"\n",(0,s.jsx)(n.h3,{id:"rucio_hostname",children:"RUCIO_HOSTNAME"}),"\n",(0,s.jsx)(n.p,{children:"This variable sets the server name in the apache config."}),"\n",(0,s.jsx)(n.h3,{id:"rucio_server_admin",children:"RUCIO_SERVER_ADMIN"}),"\n",(0,s.jsx)(n.p,{children:"This variable sets the server admin in the apache config."}),"\n",(0,s.jsx)(n.h2,{id:"rucio_cfg-configuration-parameters",children:"RUCIO_CFG configuration parameters"}),"\n",(0,s.jsxs)(n.p,{children:["Environment variables can be used to set values for the auto-generated\nrucio.cfg. The names are derived from the actual names in the configuration file\nprefixed by ",(0,s.jsx)(n.code,{children:"RUCIO_CFG"}),", e.g., the ",(0,s.jsx)(n.code,{children:"default"})," value in the ",(0,s.jsx)(n.code,{children:"database"})," section\nbecomes ",(0,s.jsx)(n.code,{children:"RUCIO_CFG_DATABASE_DEFAULT"}),". All available environment variables are:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_COMMON_LOGDIR"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_COMMON_LOGLEVEL"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_COMMON_MAILTEMPLATEDIR"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_DEFAULT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_SCHEMA"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_POOL_RESET_ON_RETURN"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_ECHO"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_POLL_RECYCLE"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_POOL_SIZE"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_POOL_TIMEOUT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_MAX_OVERFLOW"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_POWUSERACCOUNT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_DATABASE_USERPASSWORD"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_MONITOR_CARBON_SERVER"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_MONITOR_CARBON_PORT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_MONITOR_USER_SCOPE"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_TRACEDIR"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_BROKERS"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_PORT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_USERNAME"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_PASSWORD"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_TRACE_TOPIC"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_PERMISSION_POLICY"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_PERMISSION_SCHEMA"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_PERMISSION_LFN2PFN_ALGORITHM_DEFAULT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_PERMISSION_SUPPORT"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_PERMISSION_SUPPORT_RUCIO"}),"\n",(0,s.jsx)(n.li,{children:"RUCIO_CFG_WEBUI_USERCERT"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enable-oidc",children:"Enable OIDC"}),"\n",(0,s.jsx)(n.p,{children:"This section describes how to enable authentication and authorization in Rucio using OpenID Connect (OIDC), OAuth2, and JSON Web Tokens (JWTs)."}),"\n",(0,s.jsx)(n.p,{children:"Rucio currently provides full support for INDIGO IAM, and has been tested with CILogon.\nTwo separate OIDC clients must be registered in the Identity Provider (IdP): one for user authentication and one for daemon/service authorization."}),"\n",(0,s.jsx)(n.h3,{id:"registering-oidc-clients-to-identity-provider-idp",children:"Registering OIDC Clients to Identity provider (IdP)"}),"\n",(0,s.jsx)(n.p,{children:"Rucio requires two clients at the IdP:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"[C1] Rucio Auth Client\nThis client is used for interactive user authentication (CLI, WebUI) using the Authorization Code Flow."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Grant Type: ",(0,s.jsx)(n.code,{children:"authorization_code"})]}),"\n",(0,s.jsxs)(n.li,{children:["Audience: ",(0,s.jsx)(n.code,{children:"rucio"})," ."]}),"\n",(0,s.jsxs)(n.li,{children:["Scopes:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["At minimum ",(0,s.jsx)(n.code,{children:"openid"})," ."]}),"\n",(0,s.jsxs)(n.li,{children:["Default in rucio ",(0,s.jsx)(n.code,{children:"openid"})," ",(0,s.jsx)(n.code,{children:"profile"})," and ",(0,s.jsx)(n.code,{children:"email"})," ."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["redirect_uris :","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"https://<auth_server_name>/auth/oidc_token"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"https://<auth_server_name>/auth/oidc_code"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," use https for redirect_uris ."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"[C2] Rucio Admin Client\nThis client is responsible interaction to storages and FTS. Used by transfer and deletion daemons."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Grant Type: ",(0,s.jsx)(n.code,{children:"client_credentials"})]}),"\n",(0,s.jsxs)(n.li,{children:["Audience:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"<storage_hostname>"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"fts"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Scopes:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"fts"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"storage.modify:<path>"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"storage.create:<path>"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"storage.read:<path>"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"<path>"})," typically corresponds to the scope accepted by the storage, as described later."]}),"\n",(0,s.jsx)(n.p,{children:"Please save the client_id and client_secret from both of [C1] and [C2]."}),"\n",(0,s.jsx)(n.h3,{id:"preparing-idpsecretsjson",children:"Preparing idpsecrets.json"}),"\n",(0,s.jsxs)(n.p,{children:["Create an ",(0,s.jsx)(n.code,{children:"idpsecrets.json"})," file containing the configuration of the two IdP clients. Then mount this file to Rucio server and daemons.\nIf using Helm Chart then use mounting as ",(0,s.jsx)(n.a,{href:"https://github.com/rucio/helm-charts/tree/master/charts/rucio-server#additional-secrets",children:"described here"}),"."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Security:"})," Never commit ",(0,s.jsx)(n.code,{children:"idpsecrets.json"})," to version control. Store the file securely (Kubernetes Secret, encrypted backup or password manager). Mount secrets as read-only in production."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "<IdP_nickname>": {\n\n        "issuer": "https://<issuer_server_name>",\n\n        "redirect_uris": [\n            "https://<auth_server_name>/auth/oidc_token",\n            "https://<auth_server_name>/auth/oidc_code"\n        ],\n        "client_id": "<C1_client_id>",\n        "client_secret": "<C1_client_secret>",\n\n        "SCIM": {\n            "client_id": "<C2_client_id>",\n            "client_secret": "<C2_client_secret>",\n        }\n    },\n\n    "wlcg": {\n\n        "issuer": "https://wlcg.cloud.cnaf.infn.it/",\n\n        "redirect_uris": [\n            "https://rucio-auth.cern.ch/auth/oidc_token",\n            "https://rucio-auth.cern.ch/auth/oidc_code"\n        ],\n\n        "client_id": "fdc297fc-09 ...",\n        "client_secret": "APFVcga_X ...",\n\n        "SCIM": {\n            "client_id": "5b5e5d3 ...",\n            "client_secret": "IQqAcMOa ...",\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"configuring-rucio-server-for-oidc-based-authentication",children:"Configuring Rucio Server for OIDC based authentication"}),"\n",(0,s.jsxs)(n.p,{children:["The Rucio Auth Client (C1) is used for user login. Enable OIDC in ",(0,s.jsx)(n.code,{children:"rucio.cfg"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cfg",children:"[oidc]\n# Required: Path to the idpsecrets JSON file.\nidpsecrets = /path/to/your/idpsecrets.json \n\n# Required: Matches the <IdP_nickname> key in idpsecrets.json. \nadmin_issuer = <IdP_nickname>\n\n# Optional: Expected 'aud' value in the user JWT. Defaults to 'rucio'.\n# if different from default then put what you have for [C1]\nexpected_audience = 'rucio' \n\n# Optional: Expected scopes in the JWT. Defaults to 'openid profile email'.\n# if different from default then put what you have for [c1]\nexpected_scope = 'openid profile email'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each user must have an OIDC identity linked to their Rucio account. The OIDC identity consists of:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sub"})," claim which is subject claim of user."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"iss"})," claim which is issuer URL of the IdP."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'rucio account identity add --account rucio_user_account \\\n  --type OIDC \\\n  --id "SUB=5b5e5d37-926b-4b42-8a98-a0b4b28baf18, \\\n    ISS=https://wlcg.cloud.cnaf.infn.it/" \\\n  --email "wlcg-doma-rucio@cern.ch"\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": ",(0,s.jsx)(n.code,{children:"5b5e5d37-926b-4b42-8a98-a0b4b28baf18"})," is subject claim of user and ",(0,s.jsx)(n.code,{children:"https://wlcg.cloud.cnaf.infn.it/"})," is issuer url  of IdP."]}),"\n",(0,s.jsx)(n.h3,{id:"enabling-oidc-for-transfers--deletions",children:"Enabling OIDC for Transfers & Deletions"}),"\n",(0,s.jsxs)(n.p,{children:["Rucio uses WLCG profile with ",(0,s.jsx)(n.a,{href:"https://github.com/WLCG-AuthZ-WG/common-jwt-profile/blob/master/profile.md#221-capability-based-authorization-scope",children:"Capability based authorization"})," for token-based interactions with storage and FTS.\nAuthorization is applied at the RSE level: This means tokens are scoped to the RSE's storage path prefix described ",(0,s.jsx)(n.a,{href:"#defining-path-for-storage-capabilities",children:"here"}),", not to individual files or datasets. A single token grants access to perform operations on any file under the RSE's path based on its capabilities (read, create, modify)."]}),"\n",(0,s.jsx)(n.p,{children:"Token-based operations require:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The RSE must have the davs protocol enabled."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The RSE must have the oidc_support attribute set to True."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rucio rse attribute add --key oidc_support --value True RSE_NAME\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["The RSE must be able to accept token with WLCG profile and audience as its ",(0,s.jsx)(n.code,{children:"hostname"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["The RSE must allow permission for ",(0,s.jsx)(n.a,{href:"#defining-path-for-storage-capabilities",children:(0,s.jsx)(n.code,{children:"<path>"})})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["FTS must be configured to accept token ",(0,s.jsx)(n.code,{children:"fts"})," scope and ",(0,s.jsx)(n.code,{children:"<fts_hostname>"})," audience."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["FTS audience config described ",(0,s.jsx)(n.a,{href:"https://fts3-docs.web.cern.ch/fts3-docs/docs/install/token_configuration.html#configuring-the-fts-rest-component",children:"here"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["FTS scope config described ",(0,s.jsx)(n.a,{href:"https://fts3-docs.web.cern.ch/fts3-docs/docs/install/token_configuration.html#add-tokenprovider-information-to-the-database",children:"here"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"defining-path-for-storage-capabilities",children:["Defining ",(0,s.jsx)(n.code,{children:"<path>"})," for Storage Capabilities:"]}),"\n",(0,s.jsxs)(n.p,{children:["Each storage enforces a specific prefix for ",(0,s.jsx)(n.code,{children:"storage.<capability>:<path>"})," scopes.\nThere are two cases:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Storage accepts the full RSE protocol prefix"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Storage expects part of the RSE protocol prefix\nSet the oidc_base_path RSE attribute to remove the unwanted leading prefix."}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["RSE protocol prefix: ",(0,s.jsx)(n.code,{children:"/path/to/vo"})]}),"\n",(0,s.jsxs)(n.li,{children:["Storage expects: ",(0,s.jsx)(n.code,{children:"/vo"}),"\nThen add:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rucio rse attribute add --key oidc_base_path --value '/path/to' RSE_NAME\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"transfer-daemon-token-flow",children:"Transfer daemon token flow."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Transfer job submission to FTS\nFor TPC transfer rucio sends 3 tokens to FTS.\n",(0,s.jsx)(n.code,{children:"fts token [F]"}),", ",(0,s.jsx)(n.code,{children:"src storage token [S]"})," and ",(0,s.jsx)(n.code,{children:"destination storage token [D]"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," All tokens sent to FTS (",(0,s.jsx)(n.code,{children:"[F]"}),", ",(0,s.jsx)(n.code,{children:"[S]"}),", ",(0,s.jsx)(n.code,{children:"[D]"}),") are ",(0,s.jsx)(n.strong,{children:"managed tokens"}),".",(0,s.jsx)(n.br,{}),"\n","This requires configuring FTS to perform ",(0,s.jsx)(n.strong,{children:"token exchange and Just in Time token refresh"}),", so long-running transfers continue even after the original tokens sent from Rucio expires.\nMore info ",(0,s.jsx)(n.a,{href:"https://fts3-docs.web.cern.ch/fts3-docs/docs/token_support.html",children:"here"})," and ",(0,s.jsx)(n.a,{href:"https://fts3-docs.web.cern.ch/fts3-docs/docs/install/upgrades/3.14.html",children:"here"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant D as Transfer Daemon\n    participant I as Identity Provider\n    participant F as FTS\n\n    Note over D,I: Client C2 (Rucio Admin Client)\n\n    alt Tokens NOT cached\n        D->>+I: 1. Request FTS token\n        I--\x3e>-D: [F]\n\n        D->>+I: 2. Request SRC token\n        I--\x3e>-D: [S]\n\n        D->>+I: 3. Request DEST token\n        I--\x3e>-D: [D]\n    else Tokens cached\n        activate D\n        Note right of D: Load tokens<br/>from cache\n        deactivate D\n    end\n\n    D->>F: 4. Submit job [F], [S], [D]"}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Poller Daemon Token Support"}),"\n",(0,s.jsx)(n.p,{children:"For Poller to use tokens to communicate with FTS, modify to config with the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cfg",children:"[conveyor]\npoller_oidc_support = True\n"})}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant D as Poller Daemon\n    participant I as Identity Provider\n    participant F as FTS\n    Note over D,I: Client C2 (Rucio Admin Client)\n    alt Tokens NOT cached\n        D->>I: Request fts token\n        I--\x3e>D: [F]\n    else Tokens cached\n        Note over D: Load [F] from cache\n    end\n    loop Poll for status\n        D->>F: [F]\n        F--\x3e>D: Status\n    end"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Reaper (deletion) Daemon Token support."}),"\n",(0,s.jsx)(n.p,{children:"If the RSE has token enabled and meet the criteria then its enough for deletion via token."}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant D as Reaper Daemon\n    participant I as Identity Provider\n    participant S as Storage\n    Note over D,I: Client C2 (Rucio Admin Client)\n    \n    alt Tokens NOT cached\n        D->>I: Request storage token\n        I--\x3e>D: Token [S]\n    else Tokens cached\n        Note over D: Load [S] from cache\n    end\n\n    loop Delete files\n        D->>S: [S]\n    end"}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>o,x:()=>c});var r=i(96540);const s={},t=r.createContext(s);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);