"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2551],{15680:(e,n,t)=>{t.d(n,{xA:()=>p,yg:()=>d});var i=t(96540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=i.createContext({}),u=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=u(e.components);return i.createElement(s.Provider,{value:n},e.children)},g="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},f=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),g=u(t),f=r,d=g["".concat(s,".").concat(f)]||g[f]||c[f]||a;return t?i.createElement(d,o(o({ref:n},p),{},{components:t})):i.createElement(d,o({ref:n},p))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=f;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[g]="string"==typeof e?e:r,o[1]=l;for(var u=2;u<a;u++)o[u]=t[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}f.displayName="MDXCreateElement"},32210:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>u,toc:()=>g});var i=t(58168),r=t(98587),a=(t(96540),t(15680)),o=["components"],l={id:"configure-rucio-fts3-plugins",title:"Configure A Tool to Deterimine Rules For FTS3 Tape Transfers",sidebar_label:"FTS3 Transfertool Plugins"},s=void 0,u={unversionedId:"operator/transfers/configure-rucio-fts3-plugins",id:"operator/transfers/configure-rucio-fts3-plugins",title:"Configure A Tool to Deterimine Rules For FTS3 Tape Transfers",description:"Rucio includes functionality to pass instructions to FTS3 that describe how the transfer should be concluded",source:"@site/../docs/operator/transfers/configure_fts3_plugins.md",sourceDirName:"operator/transfers",slug:"/operator/transfers/configure-rucio-fts3-plugins",permalink:"/documentation/operator/transfers/configure-rucio-fts3-plugins",draft:!1,editUrl:"https://github.com/rucio/documentation/tree/main/docs/../docs/operator/transfers/configure_fts3_plugins.md",tags:[],version:"current",lastUpdatedBy:"Fabio Luchetti",lastUpdatedAt:1716902708,formattedLastUpdatedAt:"May 28, 2024",frontMatter:{id:"configure-rucio-fts3-plugins",title:"Configure A Tool to Deterimine Rules For FTS3 Tape Transfers",sidebar_label:"FTS3 Transfertool Plugins"},sidebar:"docs",previous:{title:"Configure Rucio To Use Globus Online as a Transfer Tool",permalink:"/documentation/operator/transfers/configure-rucio-globus"},next:{title:"DID Metadata",permalink:"/documentation/operator/did_meta"}},p={},g=[{value:"Writing the plugin",id:"writing-the-plugin",level:2},{value:"Plugins with initialization rules",id:"plugins-with-initialization-rules",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Pre-built plugins",id:"pre-built-plugins",level:2},{value:"Activity Based Transfer Prority",id:"activity-based-transfer-prority",level:3},{value:"Tape Collocation",id:"tape-collocation",level:3}],c={toc:g},f="wrapper";function d(e){var n=e.components,t=(0,r.A)(e,o);return(0,a.yg)(f,(0,i.A)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.yg)("p",null,"Rucio includes functionality to pass instructions to FTS3 that describe how the transfer should be concluded\n(e.g., placement on tape).\nThis information is passed forward to the storage endpoint as a json of\n",(0,a.yg)("inlineCode",{parentName:"p"},"archive_metadata"),", ",(0,a.yg)("a",{parentName:"p",href:"https://fts3-docs.web.cern.ch/fts3-docs/fts-rest/docs/bulk.html"},"as described by FTS3.")),(0,a.yg)("p",null,"The plugin ensures the metadata conforms to json encoding and size constraints before adding it to the\nparameters used in the transfer. "),(0,a.yg)("h2",{id:"writing-the-plugin"},"Writing the plugin"),(0,a.yg)("p",null,"Plugins are expected to be subclasses of ",(0,a.yg)("inlineCode",{parentName:"p"},"rucio.transfertool.fts3_plugins.FTS3TapeMetadataPlugin"),",\nand registed as ",(0,a.yg)("inlineCode",{parentName:"p"},"fts3_tape_metadata_plugins")," algorithms.\nThis is done by using the\n",(0,a.yg)("inlineCode",{parentName:"p"},"FTS3TapeMetadataPlugin.register")," method, which tells the algoritm which code to execute during runtime. "),(0,a.yg)("p",null,"The return type of the selected policy code must be a json-encodable dictionary.\nThe only required keys are the keys that will be used by the storage endpoint, not any decorators for FTS3. "),(0,a.yg)("p",null,"During the transfer, the algorithm is passed the existing job parameters generated for the transfer in the form of a dictionary. "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-python"},'from rucio.transfertool.fts3_plugins import FTS3TapeMetadataPlugin \n\nclass ExperimentFTSPlugins(FTS3TapeMetadataPlugin): \n    def __init__(self, policy_algorithm="def"): \n        super().__init__()\n        self.register("policy_algorithm", func=self.plugin_algorithm) # Name and function for the new algorithm\n\n    def plugin_algorithm(self, *hints): # Code executed at runtime\n        return {"storage_location": "this_location"}\n')),(0,a.yg)("p",null,"This will result in the below transfer. "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-json"},'{"files": [{\n    "sources": [...],\n    ...\n    "archive_metadata": {\n        "storage_location": "this_location"\n        }\n    }]\n}\n\n')),(0,a.yg)("h3",{id:"plugins-with-initialization-rules"},"Plugins with initialization rules"),(0,a.yg)("p",null,"If the plugin requires set-up that would slow down transfers, using a plugin initialization is recommended.\nThis includes things like querying the configuration file, performing a calculation that would not change\nbetween different transfers, or hard-coding parameters. "),(0,a.yg)("p",null,"This is done by including a ",(0,a.yg)("inlineCode",{parentName:"p"},"init_func")," when registing the plugin. "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-python"},'from rucio.transfertool.fts3_plugins import FTS3TapeMetadataPlugin \n\nclass ExperimentFTSPlugins(FTS3TapeMetadataPlugin): \n    def __init__(self, policy_algorithm="def"): \n        super().__init__()\n        self.register(\n            "policy_algorithm", \n            func=self.plugin_algorithm, \n            init_func=self.plugin_initialization)\n\n    def plugin_algorithm(self, *hints):\n        # Can use `self.extra_params`\n        return {\n            "storage_location": self.extra_params[hints["name"]]\n            }\n\n    def plugin_initialization(self): \n        self.extra_params = dict(get_config("transfers", "extra_params"))\n        \n')),(0,a.yg)("p",null,"To trigger registration it is recommended to run the plugin in the class file with the default plugin name. "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-{python}"},'class ExperimentFTSPlugins(FTS3TapeMetadataPlugin): \n    ...\nExperimentFTSPlugins("def")\n')),(0,a.yg)("h2",{id:"configuration"},"Configuration"),(0,a.yg)("p",null,"Configuration set in the ",(0,a.yg)("inlineCode",{parentName:"p"},"rucio.cfg"),'. To use a plugin (here named "policy_algorithm"),\nmodify the config to include the below field.\nTo use mutliple plugins, their names can be listed to make each plugin algorithm run in sequence.  '),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},'[transfers]\nfts3tape_metadata_plugins = ["policy_algorithm"]\n')),(0,a.yg)("p",null,"Size constraints can be set with the below. (Default of 4096)"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"[transfers]\nmetadata_byte_limit = <byte limit of transfer metadata> \n")),(0,a.yg)("h2",{id:"pre-built-plugins"},"Pre-built plugins"),(0,a.yg)("h3",{id:"activity-based-transfer-prority"},"Activity Based Transfer Prority"),(0,a.yg)("p",null,"To assign archive prority based on activity, we include the ",(0,a.yg)("inlineCode",{parentName:"p"},"activity_hints")," plugin.\nThis plugin assigns an integer prority between 0 and 100 based on the activity of the transfer in question. "),(0,a.yg)("p",null,"Output of the plugin follows the form of "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-json"},'{"archive_metadata": {"scheduling_hints": {"priority": 0}}}\n')),(0,a.yg)("p",null,"The plugin requires no code modification or subclassing, all set up is done in the ",(0,a.yg)("inlineCode",{parentName:"p"},"rucio.cfg"),". "),(0,a.yg)("p",null,"To set up, update your configuration as follows: "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-cfg"},'[transfers]\nfts3tape_metadata_plugins = ["activity"]\n\n[tape_priority]\n<Activity 1> = 100 \n<Activity 2> = 80\n<Activity 3> = 50\n')),(0,a.yg)("p",null,"Baseline priority for any activity not listed is ",(0,a.yg)("inlineCode",{parentName:"p"},"20"),"."),(0,a.yg)("h3",{id:"tape-collocation"},"Tape Collocation"),(0,a.yg)("p",null,"In order to ensure data is placed on tape with similar data, a ",(0,a.yg)("inlineCode",{parentName:"p"},"tape_collocation")," plugin can be used.\nThis plugin requires custom logic, but behaves as a generic plugin does. "),(0,a.yg)("p",null,"The collocation can be set to up to 4 different levels, such that the passed ",(0,a.yg)("inlineCode",{parentName:"p"},"archive_metadata")," contains the following: "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-json"},'{ \n    "collocation_hints":{\n        "1": Highest level of grouping, \n        "2": Second Highest level, \n        ...\n        "4": Lowest level of grouping \n    }\n}\n')),(0,a.yg)("p",null,"Writing the plugin is similar to any other plugin, it just requires that these 4 levels be filled for a given transfer. "),(0,a.yg)("p",null,"If the ",(0,a.yg)("inlineCode",{parentName:"p"},"collocation")," wrapper is used, this format is verified and put into the ",(0,a.yg)("inlineCode",{parentName:"p"},"collocation_hints"),"\nfield of the transfer parameters.\nThis is done below, where ",(0,a.yg)("inlineCode",{parentName:"p"},"find_level_hints")," is an attribary function written for an experiment's needs: "),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-python"},'from rucio.transfertool.fts3_plugins import FTS3TapeMetadataPlugin \n\nclass ExperimentCollocationFTSPlugins(FTS3TapeMetadataPlugin): \n    def __init__(self, policy_algorithm="def"): \n        super().__init__()\n        self.register(\n            "policy_collocation_algorithm", \n            func= lambda x: self._collocation(self._experiment_plugin, x)\n        )\n\n    def find_level_hints(self, level, hints)\n        ...\n\n    def _experiment_plugin(self, *hints):\n        return {\n                "1": self.find_level_hints(level=1, hints=hints), \n                "2": self.find_level_hints(level=2, hints=hints), \n                "3": self.find_level_hints(level=3, hints=hints),\n                "4": self.find_level_hints(level=4, hints=hints),\n            }\n\nExperimentCollocationFTSPlugins("def")\n')))}d.isMDXComponent=!0}}]);