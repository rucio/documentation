"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[83571],{32967(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"operator/monitoring","title":"Monitoring","description":"Rucio provides multiple monitoring components to observe its internal operations, data transfers, file access, and database state. These components include:","source":"@site/../docs/operator/monitoring.md","sourceDirName":"operator","slug":"/operator/monitoring","permalink":"/documentation/operator/monitoring","draft":false,"unlisted":false,"editUrl":"https://github.com/rucio/documentation/tree/main/docs/../docs/operator/monitoring.md","tags":[],"version":"current","lastUpdatedBy":"Mayank Sharma","lastUpdatedAt":1771608959000,"frontMatter":{"title":"Monitoring","sidebar_label":"Monitoring"},"sidebar":"docs","previous":{"title":"A Kubernetes tutorial","permalink":"/documentation/operator/k8s_guide"},"next":{"title":"Multi-VO Rucio","permalink":"/documentation/operator/multi_vo_rucio"}}');var o=s(74848),i=s(28453);const t={title:"Monitoring",sidebar_label:"Monitoring"},a="Rucio Monitoring Guide",l={},c=[{value:"Internal Monitoring",id:"internal-monitoring",level:2},{value:"Transfers, Deletion and Other Monitoring",id:"transfers-deletion-and-other-monitoring",level:2},{value:"Event Types",id:"event-types",level:3},{value:"Format of Messages Delivered by Hermes",id:"format-of-messages-delivered-by-hermes",level:3},{value:"Traces",id:"traces",level:2},{value:"Rucio database dump",id:"rucio-database-dump",level:2},{value:"Rucio Monitoring Probes",id:"rucio-monitoring-probes",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"rucio-monitoring-guide",children:"Rucio Monitoring Guide"})}),"\n",(0,o.jsx)(n.p,{children:"Rucio provides multiple monitoring components to observe its internal operations, data transfers, file access, and database state. These components include:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#internal-monitoring",children:(0,o.jsx)(n.strong,{children:"Internal Monitoring"})}),": Observing Rucio server and daemon performance."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#transfers-deletion-and-other-monitoring",children:(0,o.jsx)(n.strong,{children:"Transfers, Deletion, and Other Monitoring"})}),": Tracking transfers, deletions, and other Rucio events."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#traces",children:(0,o.jsx)(n.strong,{children:"File/Dataset Access Monitoring"})}),": Using traces to monitor client interactions."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#rucio-database-dump",children:(0,o.jsx)(n.strong,{children:"Database Dump and Visualization"})}),": Extracting database-level metrics for visualization."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"#rucio-monitoring-probes",children:(0,o.jsx)(n.strong,{children:"Probes"})}),": Automated checks and using Nagios or Prometheus Pushgateway."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"internal-monitoring",children:"Internal Monitoring"}),"\n",(0,o.jsx)(n.p,{children:"This is to monitor the internals of Rucio servers and daemons, e.g., submission\nrate of the conveyor, state of conveyor queues, reaper deletion rate, server\nresponse times, server active session, etc. Metrics are typically categorized as:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Counters \u2013 measure the number of events (e.g., requests processed)."}),"\n",(0,o.jsx)(n.li,{children:"Timers/Histograms \u2013 measure durations of operations (e.g., rule evaluation time, transfer submission time)."}),"\n",(0,o.jsx)(n.li,{children:"Gauges \u2013 measure values that can go up and down (e.g., number of active sessions, queue sizes)."}),"\n"]}),"\n",(0,o.jsx)(n.mermaid,{value:"%%{init: {'theme': 'base', 'themeVariables': {\n  'primaryColor': '#d8e3e7',\n  'edgeLabelBackground': '#ffffff',\n  'tertiaryColor': '#cdd5d9',\n  'fontFamily': 'monospace',\n  'primaryBorderColor': '#90a4ae',\n  'lineColor': '#90a4ae'\n}}}%%\nflowchart TB\n  subgraph RucioTransfer[\"**Internal Monitoring**\"]\n        A1[\"Rucio Servers & Daemons\"]\n\n        G1[\"Graphite\"]\n        P1[\"Prometheus\"]\n        GF[\"Grafana\"]\n  end\n\n  %% Edges\n  A1 -- \"push\" --\x3e G1\n  A1 -- \"pull or push\" --\x3e P1\n  G1 --\x3e GF\n  P1 --\x3e GF\n\n  %% Style definitions\n  classDef mono fill:#d8e3e7,stroke:#607d8b,color:#000,font-size:12px;\n  classDef Grafana fill:#F05A28,stroke:#b03e16,color:#fff,font-weight:bold;\n  classDef Graphite fill:#555555,stroke:#333333,color:#fff,font-weight:bold;  %% Dark gray for Graphite\n  classDef Prometheus fill:#009688,stroke:#00695C,color:#fff,font-weight:bold; %% Teal, distinct\n\n  %% Apply styles\n  class A1 mono;\n  class G1 Graphite;\n  class P1 Prometheus;\n  class GF Grafana;"}),"\n",(0,o.jsx)(n.p,{children:"There are two options:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Graphite"}),"\n",(0,o.jsx)(n.p,{children:"Metrics are pushed to a Graphite server."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:"[monitor]\n# specify the hostname for carbon server\ncarbon_server = <hostname>\ncarbon_port = 8125\nuser_scope = rucio\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Prometheus"}),"\n",(0,o.jsxs)(n.p,{children:["Metrics can be scraped by Prometheus or optionally pushed to Prometheus Pushgateway for short-lived processes. Prometheus also supports multiprocess-safe metrics for deployments using multiple threads or Apache MPM subprocesses. Exposed over an HTTP endpoint for scraping ",(0,o.jsx)(n.code,{children:"/metrics"}),". Multiprocess-safe metrics are supported using the PROMETHEUS_MULTIPROC_DIR environment variable."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:"[monitor]\n# Enable Prometheus metrics\nenable_metrics = True\n# Port for Prometheus HTTP server\nmetrics_port = 8080\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The used metrics can be found in following links (code search)"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/search?q=repo%3Arucio%2Frucio+Metrics.Counter&type=code",children:"Counter"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/search?q=repo%3Arucio%2Frucio+Metrics.gauge&type=code",children:"Gauge"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/search?q=repo%3Arucio%2Frucio+Metrics.timer&type=code",children:"Timer"})}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://github.com/rucio/monitoring-templates/blob/main/prometheus-monitoring/Dashboards/Rucio-Internal.json",children:"Grafana Dashboard JSON"})," for Prometheus is given here."]}),"\n",(0,o.jsx)(n.h2,{id:"transfers-deletion-and-other-monitoring",children:"Transfers, Deletion and Other Monitoring"}),"\n",(0,o.jsx)(n.p,{children:"Rucio generates a large volume of operational events for activities such as: transfers, deletions, rule evaluations, replication tasks, etc., originating from daemons like conveyor, reaper, judge, and others."}),"\n",(0,o.jsx)(n.p,{children:"These events are collected and delivered by the Hermes daemon, which can forward them to message queues or storage backends for further processing, analysis, and storage. According to your storage backend you can use visualization software like Grafana/Kibana."}),"\n",(0,o.jsx)(n.mermaid,{value:"%%{init: {'theme': 'base', 'themeVariables': {\n  'primaryColor': '#d8e3e7',\n  'edgeLabelBackground': '#ffffff',\n  'tertiaryColor': '#cdd5d9',\n  'fontFamily': 'monospace',\n  'primaryBorderColor': '#90a4ae',\n  'lineColor': '#90a4ae'\n}}}%%\nflowchart TB\n  subgraph RucioTransfer[\"**Transfer,&nbsp;Deletion&nbsp;&amp;&nbsp;Other&nbsp;Monitoring**\"]\n        A2[\"Rucio Daemon: Hermes\"]\n        Q1[\"ActiveMQ\"]\n        ETL[\"ETL / Data Pipeline\"]\n        OS1[\"OpenSearch / Elasticsearch / InfluxDB\"]\n        KB[\"Grafana / Kibana\"]\n  end\n\n  A2 -- direct write --\x3e OS1\n  A2 -- publish(STOMP) --\x3e Q1\n  Q1 -- consume --\x3e ETL\n  ETL --\x3e OS1\n  OS1 --\x3e KB\n\n  classDef mono fill:#d8e3e7,stroke:#607d8b,color:#000,font-size:12px;\n  classDef Grafana fill:#F05A28,stroke:#b03e16,color:#fff,font-weight:bold;\n  classDef OpenSearch fill:#005EB8,stroke:#003E75,color:#fff,font-weight:bold;\n  classDef mq fill:#f69f03,stroke:#b35c00,color:#fff,font-weight:bold;\n  classDef etl fill:#4CAF50,stroke:#2E7D32,color:#fff,font-weight:bold;\n\n\n  class A2,A3 mono;\n  class Q1 mq;\n  class OS1 OpenSearch;\n  class KB Grafana;\n  class ETL etl;"}),"\n",(0,o.jsx)(n.p,{children:"Different options are shown in figure and described below."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Queue-Based Pipelines"}),"\n",(0,o.jsx)(n.p,{children:"Hermes publishes events to a queue or topic in message queue (like ActiveMQ) via STOMP. Multiple consumers can process events independently, which enables real-time, decoupled processing pipelines. These events from ActiveMQ can be consumed by ETL pipelines. These Pipelines allow aggregation, transformation, enrichment, and forwarding to different storage backends of your choice."}),"\n",(0,o.jsx)(n.p,{children:"Example pipeline : ActiveMQ -> Logstash -> OpenSearch"}),"\n",(0,o.jsx)(n.p,{children:"Config for this is described below."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:"[hermes]\n# List of services Hermes should send messages to.\nservices_list = activemq\n\n# Toggle query behavior:\n# True  -> fetch bulk messages for each service individually\n# False -> fetch bulk messages across all services together\nquery_by_service = True\n\n# Bulk retrieval size for each call to the database\nbulk = 1000\n\n[messaging-hermes]\n# ActiveMQ options\n# List of broker hostnames or DNS aliases\nbrokers = amq1.example.com, amq2.example.com\n# Destination queue or topic\ndestination = /queue/rucio\n# Use SSL for ActiveMQ connection\nuse_ssl = True\n# SSL certificate files (if using SSL)\nssl_cert_file = /etc/rucio/certs/hermes-client-cert.pem\nssl_key_file = /etc/rucio/certs/hermes-client-key.pem\n# Virtual host, optional\nbroker_virtual_host = /\n# Non-SSL port (used if use_ssl=False)\nnonssl_port = 61613\n# SSL port (used if use_ssl=True)\nport = 61614\n# ActiveMQ username/password (used if use_ssl=False)\nusername =\npassword =\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Direct Delivery"}),"\n",(0,o.jsx)(n.p,{children:"These options send events directly to storage or alerting systems, bypassing queues.\nHermes can write events straight to Elasticsearch, OpenSearch, or InfluxDB. In addition can also deliver events via email which supports custom SMTP servers, credentials, and SSL/TLS."}),"\n",(0,o.jsx)(n.p,{children:"Configuration option for each type is described below."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:"# rucio.cfg\n# =========================\n# Hermes Daemon Configuration\n# =========================\n\n[hermes]\n# List of services Hermes should send messages to.\n# Supported values: influx, elastic, email, activemq\nservices_list = elastic, influx, email, activemq\n\n# Toggle query behavior:\n# True  -> fetch bulk messages for each service individually\n# False -> fetch bulk messages across all services together\nquery_by_service = True\n\n# Bulk retrieval size for each call to the database\nbulk = 1000\n\n# InfluxDB endpoint for sending aggregated metrics\ninfluxdb_endpoint = https://influxdb-host:8086/api/v2/write?org=my-org&bucket=my-bucket&precision=ns\n# Token for authenticating to InfluxDB\ninfluxdb_token = my-secret-influxdb-token\n\n# Elasticsearch endpoint for sending events\nelastic_endpoint = https://Elasticsearch-host:9200/rucio-eic-event/_bulk\n# Optional credentials if Elasticsearch is secured\nelastic_username = admin\nelastic_password = password\n\n# Email sending options\nsend_email = True\nemail_from = rucio@cern.ch\nsmtp_host = smtp.cern.ch\nsmtp_port = 587\nsmtp_username = my-smtp-user\nsmtp_password = my-smtp-pass\nsmtp_usessl = False\nsmtp_usetls = True\nsmtp_certfile =\nsmtp_keyfile =\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"event-types",children:"Event Types"}),"\n",(0,o.jsx)(n.p,{children:"Different event types are created"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Transfers: ",(0,o.jsx)(n.code,{children:"transfer-submitted"}),", ",(0,o.jsx)(n.code,{children:"transfer-submission_failed"}),", ",(0,o.jsx)(n.code,{children:"transfer-queued"}),", ",(0,o.jsx)(n.code,{children:"transfer-failed"}),", ",(0,o.jsx)(n.code,{children:"transfer-done"})]}),"\n",(0,o.jsxs)(n.li,{children:["Deletions: ",(0,o.jsx)(n.code,{children:"deletion-done"}),", ",(0,o.jsx)(n.code,{children:"deletion-not-found"}),", ",(0,o.jsx)(n.code,{children:"deletion-failed"})]}),"\n",(0,o.jsxs)(n.li,{children:["Rules: ",(0,o.jsx)(n.code,{children:"RULE_OK"}),", and ",(0,o.jsx)(n.code,{children:"RULE_PROGRESS"})]}),"\n",(0,o.jsxs)(n.li,{children:["Locks: ",(0,o.jsx)(n.code,{children:"DATASETLOCK_OK"})]}),"\n",(0,o.jsxs)(n.li,{children:["DIDs: ",(0,o.jsx)(n.code,{children:"CREATE_CNT"})," and ",(0,o.jsx)(n.code,{children:"CREATE_DTS"})]}),"\n",(0,o.jsxs)(n.li,{children:["Replicas: ",(0,o.jsx)(n.code,{children:"INCOMPLETE"})," and ",(0,o.jsx)(n.code,{children:"ERASE"})]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The structure of messages table which is extracted by Hermes is:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "id": "UUID4",\n  "services": "<service_name>",\n  "event_type": "<event_type>",\n  "created_at": "yyyy-MM-dd HH:mm:ss.SSSSSS",\n  "payload": {},\n  "payload_nolimit": {},\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"where:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"id"}),": UUID string"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"event_type"}),": string describing the event_type listed before"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"payload"}),": small JSON object (max 4000 chars), structure varies by event type"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"payload_nolimit"}),": optional large JSON object. Only if payload larger than 4000 characters"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"services"}),": string identifying the service. (elastic, activemq, influx)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"created_at"}),": When the message was created. ISO 8601 timestamps"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"To quickly inspect the payloads of these event types:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"SELECT id, created_at, payload\nFROM messages\nWHERE event_type = '<event_type>'\nORDER BY created_at DESC\nLIMIT 2;\n"})}),"\n",(0,o.jsxs)(n.p,{children:["replace ",(0,o.jsx)(n.code,{children:"event_type"})," with actual name that you want to inspect. We can also check ",(0,o.jsx)(n.code,{children:"messages_history"})," table."]}),"\n",(0,o.jsx)(n.h3,{id:"format-of-messages-delivered-by-hermes",children:"Format of Messages Delivered by Hermes"}),"\n",(0,o.jsx)(n.p,{children:"The final format of the message is determined by the destination service, as Hermes transforms the raw database message into the required wire protocol for external systems."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["ActiveMQ (STOMP Message): The body is a streamlined JSON object containing only ",(0,o.jsx)(n.code,{children:"event_type"}),", ",(0,o.jsx)(n.code,{children:"payload"}),", and ",(0,o.jsx)(n.code,{children:"created_at"}),". The message uses STOMP headers to set the event_type and flag the message as persistent."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Elasticsearch / OpenSearch (Bulk API): Hermes sends the raw database JSON message (including ",(0,o.jsx)(n.code,{children:"id"})," and ",(0,o.jsx)(n.code,{children:"services"}),") as a document using Bulk API format (via a POST request)."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["InfluxDB (Line Protocol): Hermes performs on-the-fly aggregation of transfers and deletions, counting successes/failures and bytes. It does not send the raw event JSON. The final format is the InfluxDB Line Protocol, which consists of a single text line combining the measurement, tags (e.g., RSE, activity), fields (e.g., ",(0,o.jsx)(n.code,{children:"nb_done=10"}),"), and a timestamp."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Example Grafana dashboard for transfer is provided ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/monitoring-templates/blob/main/message-monitoring/Dashboards/Rucio-Transfer.json",children:"here"})]}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note"}),": Please make changes to the dashboard according to your setup and needs."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"traces",children:"Traces"}),"\n",(0,o.jsxs)(n.p,{children:["Rucio clients can send trace events on every file upload or download. These are posted to the ",(0,o.jsx)(n.code,{children:"/traces"})," endpoint and forwarded to a message broker such as ActiveMQ via STOMP. Messages are consumed by Rucio\u2019s Kronos daemon or by external consumers."]}),"\n",(0,o.jsxs)(n.p,{children:["This is shown in figure below. Schemas of the traces can be found in ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/rucio/blob/master/lib/rucio/core/trace.py",children:(0,o.jsx)(n.code,{children:"trace.py"})})," which can be used for dashboards."]}),"\n",(0,o.jsx)(n.mermaid,{value:"%%{init: {'theme': 'base', 'themeVariables': {\n  'primaryColor': '#d8e3e7',\n  'edgeLabelBackground': '#ffffff',\n  'tertiaryColor': '#cdd5d9',\n  'fontFamily': 'monospace',\n  'primaryBorderColor': '#90a4ae',\n  'lineColor': '#90a4ae'\n}}}%%\nflowchart TB\n  subgraph RucioTraceFlow[\"**Rucio Trace Flow**\"]\n        C1[\"Clients / Pilots\"]\n        RS[\"Rucio Server (/traces endpoint)\"]\n        Q1[\"ActiveMQ\"]\n        KR[\"Rucio Daemon: Kronos\"]\n        ETL[\"ETL / Data Pipeline\"]\n        OS1[\"OpenSearch / Elasticsearch / InfluxDB\"]\n        KB[\"Grafana / Kibana\"]\n  end\n\n  C1 -- traces (HTTPS POST) --\x3e RS\n  RS -- publish(STOMP) --\x3e Q1\n  Q1 -- consume(STOMP) --\x3e KR\n  Q1 -- consume --\x3e ETL\n  ETL --\x3e OS1\n  OS1 --\x3e KB\n\n  classDef mono fill:#d8e3e7,stroke:#607d8b,color:#000,font-size:12px;\n  classDef Grafana fill:#F05A28,stroke:#b03e16,color:#fff,font-weight:bold;\n  classDef OpenSearch fill:#005EB8,stroke:#003E75,color:#fff,font-weight:bold;\n  classDef mq fill:#f69f03,stroke:#b35c00,color:#fff,font-weight:bold;\n  classDef etl fill:#4CAF50,stroke:#2E7D32,color:#fff,font-weight:bold;\n\n  class C1,RS,KR mono;\n  class Q1 mq;\n  class OS1 OpenSearch;\n  class KB Grafana;\n  class ETL etl;"}),"\n",(0,o.jsx)(n.h2,{id:"rucio-database-dump",children:"Rucio database dump"}),"\n",(0,o.jsx)(n.p,{children:"Database-level monitoring extracts different information directly from the Rucio database. This includes insights such as RSE usage statistics, account quotas, and other metadata relevant to experiments. These data are periodically queried and exported to external storage backends for visualization and long-term monitoring."}),"\n",(0,o.jsxs)(n.p,{children:["Some example Logstash pipeline definitions are given ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/monitoring-templates/blob/main/logstash-monitoring/Pipelines/pipelines.yml",children:"here"}),". These example pipelines use the Logstash JDBC input plugin to connect to the Rucio PostgreSQL database, execute SQL queries, and extract structured data periodically. The retrieved records are then sent to Elasticsearch but can be changed to other storage backends such as OpenSearch. The following diagram shows the high-level flow for database-level monitoring using Logstash."]}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note"})," : While this example uses Logstash, you can use other data collector options like ",(0,o.jsx)(n.a,{href:"https://www.fluentd.org/",children:"fluentd"})," with ",(0,o.jsx)(n.a,{href:"https://github.com/fluent/fluent-plugin-sql",children:"plugin"})," depending on your requirements."]}),"\n"]}),"\n",(0,o.jsx)(n.mermaid,{value:"%%{init: {'theme': 'base', 'themeVariables': {\n  'primaryColor': '#d8e3e7',\n  'edgeLabelBackground': '#ffffff',\n  'tertiaryColor': '#cdd5d9',\n  'fontFamily': 'monospace',\n  'primaryBorderColor': '#90a4ae',\n  'lineColor': '#90a4ae'\n}}}%%\nflowchart TB\n  subgraph DB[\"**Database&nbsp;Level&nbsp;Accounting/Monitoring**\"]\n        DB1[(\"Rucio DB\")]\n        LS[\"Logstash JDBC Input\"]\n        OS2[\"OpenSearch / Elasticsearch\"]\n        GD[\"Grafana / Kibana\"]\n  end\n\n  DB1 --\x3e LS\n  LS --\x3e OS2\n  OS2 --\x3e GD\n\n  classDef mono fill:#d8e3e7,stroke:#607d8b,color:#000,font-size:12px;\n  classDef Grafana fill:#F05A28,stroke:#b03e16,color:#fff,font-weight:bold;\n  classDef OpenSearch fill:#005EB8,stroke:#003E75,color:#fff,font-weight:bold;\n  classDef Logstash fill:#b34700,stroke:#b34700,color:#fff,font-weight:bold;\n\n\n  class DB1,LS mono;\n  class LS Logstash;\n  class OS2 OpenSearch;\n  class GD Grafana;"}),"\n",(0,o.jsx)(n.p,{children:"A typical Logstash configuration consists of three sections \u2014 input, filter, and output. For example, the input section defines the PostgreSQL connection and SQL query to fetch data:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'input {\n   jdbc {\n      jdbc_connection_string => "jdbc:postgresql://host:5432/<dbname>""\n      jdbc_user => ""\n      jdbc_password => ""\n      jdbc_driver_library => "/usr/share/logstash/java/postgresql-<version>.jar"\n      jdbc_driver_class => "org.postgresql.Driver"\n      statement => "SELECT rses.rse, rse_usage.source, rse_usage.used, rse_usage.free, rse_usage.files FROM rse_usage INNER JOIN rses ON rse_usage.rse_id=rses.id WHERE rse_usage.files IS NOT NULL AND rse_usage.files!=0;"\n      schedule => "0 0 * * *"\n   }\n}\n\nfilter {\n   # Placeholder for transformations or enrichments\n   # Examples:\n   # - Add computed fields\n   # - Rename fields\n   # - Convert units (e.g., bytes to GB)\n   # - Drop unwanted fields\n}\n\n\noutput {\n  elasticsearch {\n    hosts => ["http://elasticsearch:9200"]\n    action => "index"\n    index => "rucio_rse"\n    user => "elastic"\n    password => "password"\n  }\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Few points:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"jdbc_driver_library"}),": Can be downloaded from ",(0,o.jsx)(n.a,{href:"https://jdbc.postgresql.org/",children:"jdbc.postgresql.org"}),", choose the version that you want to use and enable that in Logstash."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"schedule"}),": Defines how often the query runs (Cron-like syntax)."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"output"}),": Defines where the extracted data are delivered. In most deployments, these are indexed into OpenSearch or Elasticsearch for analytics dashboards in Grafana or Kibana."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"filter"}),": This is optional. It helps in preprocessing your data before indexing"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://github.com/rucio/monitoring-templates/blob/main/logstash-monitoring/Dashboards/Rucio-Storage.json",children:"Grafana dashboard"})," example for RSE given."]}),"\n",(0,o.jsx)(n.h2,{id:"rucio-monitoring-probes",children:"Rucio Monitoring Probes"}),"\n",(0,o.jsxs)(n.p,{children:["Rucio provides a collection of ",(0,o.jsx)(n.strong,{children:"monitoring probes"})," that check the different status metrics of the Rucio.\nThe list of probes is available ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/probes/tree/master/common",children:"here"})," probes shared across experiments. Also can create experiment-specific probes for custom monitoring like ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/probes/tree/master/atlas",children:"ATLAS"})," and ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/probes/tree/master/cms",children:"CMS"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Rucio provides a prebuilt container on ",(0,o.jsx)(n.a,{href:"https://hub.docker.com/r/rucio/probes",children:"Docker Hub"})," that includes:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"All dependencies for running the probes."}),"\n",(0,o.jsxs)(n.li,{children:["A lightweight ",(0,o.jsx)(n.strong,{children:"Jobber"})," daemon for scheduling probe execution."]}),"\n",(0,o.jsx)(n.li,{children:"The full Rucio probe repository. Custom probes can be added by introducing them to your own Rucio instance."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["The container can push results either to a ",(0,o.jsx)(n.strong,{children:"Prometheus Pushgateway"})," or export data for ",(0,o.jsx)(n.strong,{children:"Nagios"})," alerting."]}),"\n",(0,o.jsx)(n.mermaid,{value:"%%{init: {'theme': 'base', 'themeVariables': {\n  'primaryColor': '#d8e3e7',\n  'edgeLabelBackground': '#ffffff',\n  'tertiaryColor': '#cdd5d9',\n  'fontFamily': 'monospace',\n  'primaryBorderColor': '#90a4ae',\n  'lineColor': '#90a4ae'\n}}}%%\nflowchart LR\n  Probe[\"Rucio Probes (Schedule via Jobber or others)\"]\n  Nagios[\"Nagios\"]\n  Prometheus[\"Prometheus\"]\n  Grafana[\"Grafana Dashboards\"]\n\n  Probe -- Exit code + stdout --\x3e Nagios\n  Probe -- Gauge metrics  via Pushgateway--\x3e Prometheus\n  Prometheus --\x3e Grafana\n\n  classDef probe fill:#d8e3e7,stroke:#607d8b,color:#000,font-size:12px;\n  classDef nagios fill:#E53935,stroke:#B71C1C,color:#fff,font-weight:bold;\n  classDef prom fill:#00868,stroke:#00695C,color:#fff,font-weight:bold;\n  classDef graf fill:#F05A28,stroke:#b03e16,color:#fff,font-weight:bold;\n\n  class Probe probe;\n  class Nagios nagios;\n  class prometheus prom;\n  class Grafana graf;"}),"\n",(0,o.jsx)(n.p,{children:"Probe Execution Workflow is:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Probes"})," are Python scripts under ",(0,o.jsx)(n.code,{children:"rucio/probes/"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Jobber"})," acts as a cron-like scheduler inside the container."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Output options:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Prometheus Pushgateway:"})," for time-series metrics. Alerts can be added with ",(0,o.jsx)(n.a,{href:"https://prometheus.io/docs/alerting/latest/alertmanager/",children:"Prometheus"})," and ",(0,o.jsx)(n.a,{href:"https://grafana.com/docs/grafana/latest/alerting/set-up/configure-alertmanager/",children:"Grafana"})," alert management."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Nagios:"})," Used mainly as a cron-style runner where exit codes trigger Nagios alerts, while probe metrics are sent to Prometheus."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["To make use of Prometheus functionality, make sure your ",(0,o.jsx)(n.code,{children:"rucio.cfg"})," inside the container with the probes has the extra sections and options:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:'[monitor]\nprometheus_servers = "https://prometheuserver:port"\nprometheus_prefix = "" # default empty\nprometheus_labels = "" # default empty\n'})}),"\n",(0,o.jsxs)(n.p,{children:["For adding cron-like scheduling for each probe in jobber, make sure you have added needed config in ",(0,o.jsx)(n.a,{href:"https://github.com/rucio/containers/blob/master/probes/dot-jobber",children:"dot-jobber"}),". An example config is given below, running the probes ",(0,o.jsx)(n.code,{children:"check_expired_dids"})," and ",(0,o.jsx)(n.code,{children:"check_stuck_rules"}),". This config assumes your probes are in the top level directory of the container."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"version: 1.4\njobs:\n  - name: CheckExpiredDIDs\n    cmd: ./check_expired_dids\n    time: '*/5 * * * *'    # every 5 minutes\n    onError: Continue\n  - name: CheckStuckRules\n    cmd: ./check_stuck_rules\n    time: '0 * * * *'      # hourly\n    onError: Continue\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453(e,n,s){s.d(n,{R:()=>t,x:()=>a});var r=s(96540);const o={},i=r.createContext(o);function t(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);