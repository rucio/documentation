"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2602],{28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>r});var o=i(96540);const s={},t=o.createContext(s);function c(e){const n=o.useContext(t);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),o.createElement(t.Provider,{value:n},e.children)}},69859:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>d,frontMatter:()=>c,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"operator/policy_packages/policy-package-development","title":"Developing a Policy Package","description":"The basic elements of a policy package are the following:","source":"@site/../docs/operator/policy_packages/policy_package_development.md","sourceDirName":"operator/policy_packages","slug":"/operator/policy_packages/policy-package-development","permalink":"/documentation/operator/policy_packages/policy-package-development","draft":false,"unlisted":false,"editUrl":"https://github.com/rucio/documentation/tree/main/docs/../docs/operator/policy_packages/policy_package_development.md","tags":[],"version":"current","lastUpdatedBy":"Martin Barisits","lastUpdatedAt":1756125144000,"frontMatter":{"id":"policy-package-development","title":"Developing a Policy Package"},"sidebar":"docs","previous":{"title":"Developing Policy Package algorithms","permalink":"/documentation/operator/policy_packages/policy-package-algorithms"},"next":{"title":"Deploying a Policy Package","permalink":"/documentation/operator/policy_packages/policy-package-deployment"}}');var s=i(74848),t=i(28453);const c={id:"policy-package-development",title:"Developing a Policy Package"},r=void 0,a={},l=[{value:"<code>__init__.py</code>",id:"__init__py",level:3},{value:"<code>SUPPORTED_VERSION</code>",id:"supported_version",level:4},{value:"From Rucio 36",id:"from-rucio-36",level:5},{value:"Before Rucio 36",id:"before-rucio-36",level:5},{value:"<code>get_algorithms</code>",id:"get_algorithms",level:4},{value:"Permission and schema modules",id:"permission-and-schema-modules",level:3}];function p(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",h5:"h5",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"The basic elements of a policy package are the following:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["An ",(0,s.jsx)(n.code,{children:"__init__.py"})," file that:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["indicates the supported Rucio version via the ",(0,s.jsx)(n.code,{children:"SUPPORTED_VERSION"})," field;"]}),"\n",(0,s.jsx)(n.li,{children:"indicates the algorithms provided by the package (optional)"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["A ",(0,s.jsx)(n.code,{children:"permission.py"})," module implementing permission\ncustomisations (optional)."]}),"\n",(0,s.jsxs)(n.li,{children:["A ",(0,s.jsx)(n.code,{children:"schema.py"})," module implementing schema customization (optional)."]}),"\n",(0,s.jsx)(n.li,{children:"One or more files for experiment-specific algorithms (optional)."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The recommended Python package layouts can be found ",(0,s.jsx)(n.a,{href:"https://packaging.python.org/en/latest/discussions/src-layout-vs-flat-layout/",children:"here"}),". An example ",(0,s.jsx)(n.code,{children:"src"}),"-layout based policy package is as such:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"experiment-rucio-policy-package\n\u2502   README.md\n\u2502   pyproject.toml\n\u2502\n\u2514\u2500\u2500\u2500src\n\u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500experiment-rucio-policy-package\n\u2502       \u2502   __init__.py               # required\n\u2502       \u2502   permission.py             # optional\n\u2502       \u2502   schema.py                 # optional\n\u2502       \u2502   pfn2lfn.py                # optional (deterministic scope translation algorithm)\n\u2502       \u2502   non_deterministic_pfn.py  # optional (non-deterministic scope translation algorithm)\n\u2502       \u2502   ...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"__init__py",children:(0,s.jsx)(n.code,{children:"__init__.py"})}),"\n",(0,s.jsx)(n.h4,{id:"supported_version",children:(0,s.jsx)(n.code,{children:"SUPPORTED_VERSION"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"__init__.py"})," should define a ",(0,s.jsx)(n.code,{children:"str | list[str]"})," called ",(0,s.jsx)(n.code,{children:"SUPPORTED_VERSION"}),",\nindicating the version(s) of Rucio that your package supports."]}),"\n",(0,s.jsx)(n.p,{children:"This is checked against the Rucio server\nversion to ensure compatibility when loading the policy package."}),"\n",(0,s.jsx)(n.h5,{id:"from-rucio-36",children:"From Rucio 36"}),"\n",(0,s.jsxs)(n.p,{children:["From Rucio 36, version checking was modified\nto use ",(0,s.jsx)(n.a,{href:"https://peps.python.org/pep-0440/#version-specifiers",children:"PEP-compliant version specifiers"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, to specify support for the entire Rucio 36 release line (so 36.1.0, 36.2.0...)\nwithout yet supporting Rucio 37,\nthe ",(0,s.jsxs)(n.a,{href:"https://peps.python.org/pep-0440/#compatible-release",children:[(0,s.jsx)(n.strong,{children:"compatible release"})," operator"]})," ",(0,s.jsx)(n.code,{children:"~="}),"\ncan be used, as seen below."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"SUPPORTED_VERSION = '~=36.0'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Multiple constraints can be specified, either as a string:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"SUPPORTED_VERSION = '~=36.0,!=36.4.0'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Or as a list:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"SUPPORTED_VERSION = ['~=36.0','!=36.4.0']\n"})}),"\n",(0,s.jsx)(n.h5,{id:"before-rucio-36",children:"Before Rucio 36"}),"\n",(0,s.jsx)(n.p,{children:"On Rucio versions older than 36, only major versions can be specified.\nThis can be done as either a string:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"SUPPORTED_VERSION = '35'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Or as a list, to indicate support for multiple major versions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"SUPPORTED_VERSION = ['34', '35']\n"})}),"\n",(0,s.jsx)(n.h4,{id:"get_algorithms",children:(0,s.jsx)(n.code,{children:"get_algorithms"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"__init__.py"})," file can also contain\nan optional function called ",(0,s.jsx)(n.code,{children:"get_algorithms"}),' that\nreturns a dictionary of custom algorithms implemented within the package.\nIn fact, this structure should be a "dictionary of dictionaries" where\nthe outer dictionary contains algorithm types, and each inner\ndictionary contains all the algorithms provided by the package for that\ntype. Currently supported types are ',(0,s.jsx)(n.code,{children:"lfn2pfn"})," for generating PFNs for\ndeterministic storage, ",(0,s.jsx)(n.code,{children:"non_deterministic_pfn"})," for generating PFNs for\nnon-deterministic storage, and ",(0,s.jsx)(n.code,{children:"scope"})," for scope extraction algorithms.\n(For backwards compatibility, ",(0,s.jsx)(n.code,{children:"surl"})," can be used in place of\n",(0,s.jsx)(n.code,{children:"non_deterministic_pfn"}),", however this is not recommended for new policy\npackages)."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["[!NOTE]\nSome base algorithm classes depend on ",(0,s.jsx)(n.code,{children:"schema"})," being loaded.\nTo avoid ",(0,s.jsx)(n.strong,{children:"circular import"})," issues,\nimport the algorithm classes as part of the ",(0,s.jsx)(n.code,{children:"get_algorithms"})," function,\nto ensure that ",(0,s.jsx)(n.code,{children:"schema"})," is loaded first."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"def get_algorithms():\n    from vo_policy_package.non_deterministic_pfn import VONonDeterministicPFNAlgorithm\n    from vo_policy_package.lfn2pfn import VORSEDeterministicTranslation\n    from vo_policy_package.scope import VOScopeExtractionAlgorithm\n    return {\n      'non_deterministic_pfn': {\n        'voname_non_deterministic_pfn': VONonDeterministicPFNAlgorithm.construct_non_deterministic_pfn_voname\n        },\n      'lfn2pfn': {\n        'voname_lfn2pfn': VORSEDeterministicTranslation.lfn2pfn_voname\n        },\n      'scope': {\n        'voname_extract_scope': VOScopeExtractionAlgorithm.extract_scope_voname\n        }\n      }\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In all cases the names used to register the functions (e.g. ",(0,s.jsx)(n.code,{children:"voname_extract_scope"}),") must be prefixed\nwith the name of the virtual organisation that owns the policy package,\nto avoid naming conflicts on multi-VO Rucio installations."]}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/documentation/operator/policy_packages/policy-package-algorithms",children:"the Algorithms documentation page"})," for more on developing algorithms."]}),"\n",(0,s.jsx)(n.h3,{id:"permission-and-schema-modules",children:"Permission and schema modules"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"permission.py"})," and ",(0,s.jsx)(n.code,{children:"schema.py"})," modules are optional; an experiment\nthat does not need to customise these modules can omit one or both of\nthem from the policy package and the Rucio generic versions will be\nused instead. If these modules are required, the easiest way to create\nthem is to modify the generic versions from the Rucio codebase. These\ncan be found in\n",(0,s.jsx)(n.a,{href:"https://github.com/rucio/rucio/blob/master/lib/rucio/core/permission/generic.py",children:(0,s.jsx)(n.code,{children:"lib/rucio/core/permission/generic.py"})}),"\nand ",(0,s.jsx)(n.a,{href:"https://github.com/rucio/rucio/blob/master/lib/rucio/common/schema/generic.py",children:(0,s.jsx)(n.code,{children:"lib/rucio/common/schema/generic.py"})})," respectively."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"has_permission"})," function in the permission module may return ",(0,s.jsx)(n.code,{children:"None"}),"\nif your experiment does not implement a custom permission check for a\nparticular action. In this case, the generic permission module will be\ncalled for this action instead."]}),"\n",(0,s.jsx)(n.p,{children:"The schema module of a policy package does not need to define all of\nthe schema values. Any missing ones will automatically be loaded from\nthe generic schema module instead."})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}}}]);