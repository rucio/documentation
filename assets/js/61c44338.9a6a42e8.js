"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1311],{44354:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"operator/k8s_guide","title":"A Kubernetes tutorial","description":"This tutorial contains some parts that are CERN-specific.","source":"@site/../docs/operator/k8s_guide.md","sourceDirName":"operator","slug":"/operator/k8s_guide","permalink":"/documentation/operator/k8s_guide","draft":false,"unlisted":false,"editUrl":"https://github.com/rucio/documentation/tree/main/docs/../docs/operator/k8s_guide.md","tags":[],"version":"current","lastUpdatedBy":"voetberg","lastUpdatedAt":1733493511000,"frontMatter":{"id":"k8s_guide","title":"A Kubernetes tutorial"},"sidebar":"docs","previous":{"title":"Configuration","permalink":"/documentation/operator/configuration"},"next":{"title":"Multi-VO Rucio","permalink":"/documentation/operator/multi_vo_rucio"}}');var r=t(74848),i=t(28453);const a={id:"k8s_guide",title:"A Kubernetes tutorial"},c="Getting Started",o={},l=[{value:"Creating the Rucio cluster on Openstack",id:"creating-the-rucio-cluster-on-openstack",level:2},{value:"Create the database with DBOD",id:"create-the-database-with-dbod",level:2},{value:"Bootstrapping the database",id:"bootstrapping-the-database",level:3},{value:"1. The Rucio DB init container",id:"1-the-rucio-db-init-container",level:4},{value:"2. The bootstrapping pod",id:"2-the-bootstrapping-pod",level:4},{value:"Creating a LanDB set",id:"creating-a-landb-set",level:2},{value:"Managing secrets",id:"managing-secrets",level:2},{value:"Sealed-Secrets",id:"sealed-secrets",level:3},{value:"Creating secrets for the cluster",id:"creating-secrets-for-the-cluster",level:3},{value:"Rucio Servers",id:"rucio-servers",level:2},{value:"Produce the Helm chart",id:"produce-the-helm-chart",level:3},{value:"Setup the LB",id:"setup-the-lb",level:3},{value:"Produce the certificates related to the landb-alias",id:"produce-the-certificates-related-to-the-landb-alias",level:3},{value:"Create the <code>host</code>, <code>key</code>, <code>ca</code> and <code>GridCA</code> files",id:"create-the-host-key-ca-and-gridca-files",level:4},{value:"Important information about <code>ca.pem</code> and <code>GridCA.pem</code>",id:"important-information-about-capem-and-gridcapem",level:5},{value:"Add the certificates as secrets and mount them on the k8s pods",id:"add-the-certificates-as-secrets-and-mount-them-on-the-k8s-pods",level:3},{value:"Rucio Auth",id:"rucio-auth",level:2},{value:"Rucio Daemons",id:"rucio-daemons",level:2},{value:"FTS renewal and delegation",id:"fts-renewal-and-delegation",level:3},{value:"How does FTS work: users&#39; x509 certs",id:"how-does-fts-work-users-x509-certs",level:4},{value:"How does FTS work: service x509 cert",id:"how-does-fts-work-service-x509-cert",level:4},{value:"How to connect to the proper VO?",id:"how-to-connect-to-the-proper-vo",level:4},{value:"Additional environment variables",id:"additional-environment-variables",level:3},{value:"Rucio UI",id:"rucio-ui",level:2},{value:"Proxy block",id:"proxy-block",level:3},{value:"Installing <code>rucio-clients</code>",id:"installing-rucio-clients",level:2},{value:"Installing <code>gfal</code>",id:"installing-gfal",level:3},{value:"Creating the Rucio root account configuration file",id:"creating-the-rucio-root-account-configuration-file",level:2},{value:"Optional: creating a rucio client user pod in the cluster",id:"optional-creating-a-rucio-client-user-pod-in-the-cluster",level:3},{value:"Rucio admin usage",id:"rucio-admin-usage",level:2},{value:"Create the Rucio Storage Elements (RSEs)",id:"create-the-rucio-storage-elements-rses",level:3},{value:"Add the protocol definitions for the storage servers",id:"add-the-protocol-definitions-for-the-storage-servers",level:3},{value:"Enable FTS",id:"enable-fts",level:3},{value:"Fake a full mesh network",id:"fake-a-full-mesh-network",level:3},{value:"Set indefinite storage quota for root",id:"set-indefinite-storage-quota-for-root",level:3},{value:"Create a default scope for testing",id:"create-a-default-scope-for-testing",level:3},{value:"Data management",id:"data-management",level:2},{value:"Create initial transfer testing data",id:"create-initial-transfer-testing-data",level:3},{value:"Upload the files",id:"upload-the-files",level:3},{value:"Create a few datasets and containers",id:"create-a-few-datasets-and-containers",level:3},{value:"Create a rule and remember returned rule ID",id:"create-a-rule-and-remember-returned-rule-id",level:3}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"getting-started",children:"Getting Started"})}),"\n",(0,r.jsx)(n.admonition,{title:"DISCLAIMER",type:"warning",children:(0,r.jsxs)(n.p,{children:["This tutorial contains some parts that are CERN-specific. ",(0,r.jsx)("br",{}),"\nThe tools utilised to set up and to run the cluster are chosen accordingly. Feel free to use your own."]})}),"\n",(0,r.jsx)(n.p,{children:"In order to efficiently manage the cluster and implement continuous delivery, the following tools are required."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Kubernetes"}),": ",(0,r.jsx)(n.code,{children:"kubectl"}),"\n(",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/",children:"Reference Documentation"}),")."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Helm Charts"}),"\n(",(0,r.jsx)(n.a,{href:"https://helm.sh/docs/intro/install/#from-script",children:"Reference Documentation"}),"). ",(0,r.jsx)("br",{}),"\nTo install Helm, execute:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3\n\nchmod 700 get_helm.sh\n\n./get_helm.sh\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Also, add the ",(0,r.jsx)(n.code,{children:"bitnami"})," repo:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-helm",children:"helm repo add bitnami https://charts.bitnami.com/bitnami\n"})}),"\n",(0,r.jsxs)(n.p,{children:["So that we can search the repo with ",(0,r.jsx)(n.code,{children:"helm search repo bitnami"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Continuous delivery"}),": ",(0,r.jsx)(n.code,{children:"flux"}),"\n(",(0,r.jsx)(n.a,{href:"https://fluxcd.io/flux/get-started/",children:"Reference Documentation"}),")."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://fluxcd.io/flux/installation/#install-the-flux-cli",children:"Install the Flux CLI"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'curl -s https://fluxcd.io/install.sh | sudo bash\ngit status\ngit add .\ngit commit -m "first commit"\ngit push\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://fluxcd.io/flux/cmd/flux_bootstrap_gitlab/",children:"Bootstrap Flux"}),"\nThen setup the flux in the gitlab repo, by exporting the secret and running the command","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"flux bootstrap gitlab \\\n  --owner=<group> \\\n  --repository=<repository name> \\\n  --branch=<main branch> \\\n  --path=<path> \\\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"(optional) Monitoring"}),": ",(0,r.jsx)(n.code,{children:"k9s"}),". ",(0,r.jsx)("br",{}),"\nGet the binary from ",(0,r.jsx)(n.a,{href:"https://github.com/derailed/k9s/releases",children:"here"})," looking for the proper dist; extract, and move to ",(0,r.jsx)(n.code,{children:"/usr/local/bin/"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"setting-up-the-cern-infrastructure",children:"Setting up the CERN infrastructure"}),"\n",(0,r.jsx)(n.h2,{id:"creating-the-rucio-cluster-on-openstack",children:"Creating the Rucio cluster on Openstack"}),"\n",(0,r.jsxs)(n.p,{children:["Please refer to the ",(0,r.jsx)(n.a,{href:"https://kubernetes.docs.cern.ch/docs/getting-started/",children:"documentation"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["There are two kinds of operative components within the cluster: the ",(0,r.jsx)(n.em,{children:"master"})," and the ",(0,r.jsx)(n.em,{children:"worker"})," nodes:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The master node hosts the Kubernetes control plane and manages the cluster, including scheduling and scaling applications and maintaining the state of the cluster."}),"\n",(0,r.jsx)(n.li,{children:"The worker nodes are responsible for running the containers and executing the workloads."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["It is recommended to choose a master node with a sufficient amount of memory, e.g. ",(0,r.jsx)(n.code,{children:"m2.large"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The minimum working configuration consists of 1 master node and 5 worker nodes."}),"\n",(0,r.jsx)(n.h2,{id:"create-the-database-with-dbod",children:"Create the database with DBOD"}),"\n",(0,r.jsxs)(n.p,{children:["Create a DataBase On Demand (DBOD) using the ",(0,r.jsx)(n.a,{href:"https://dbod.web.cern.ch/pages/dashboard",children:"DBOD dashboard"}),";  ",(0,r.jsx)(n.code,{children:"postgres"})," is highly recommended."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The operator will have to wait for the db to be approved. Will get a mail and will receive admin credentials (to be changed) as shown below."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Additional resources:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/vre-hub/vre/wiki/Software-components#2-database",children:"https://github.com/vre-hub/vre/wiki/Software-components#2-database"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://codimd.web.cern.ch/s/ZFIkp7PWG#2-Database-configuration",children:"https://codimd.web.cern.ch/s/ZFIkp7PWG#2-Database-configuration"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Once the db creation is finalised, we can use ",(0,r.jsx)(n.code,{children:"psql"}),", to set up the credentials.\nIn the following example, we chose the name ",(0,r.jsx)(n.code,{children:"rucioitdb"})," for the database; in general, the naming of the DBOD instance is the operator's choice:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"dnf install postgresql-server\n\npsql -h dbod-rucioitdb.cern.ch -U admin -p <port> -c '\\password'\n"})}),"\n",(0,r.jsx)(n.p,{children:"Details about which port to connect to, etc can be found on the DBOD dashboard."}),"\n",(0,r.jsxs)(n.p,{children:["While inside the db instance, we can create the ",(0,r.jsx)(n.code,{children:"rucio"})," user and db, and we can assign admin privileges to it:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE ROLE rucio WITH LOGIN PASSWORD 'xxx';\nALTER GROUP rucio ADD USER admin;\nCREATE DATABASE rucio;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then, modify the ",(0,r.jsx)(n.code,{children:"pg.hba.conf"})," configuration file on the DBOD dashboard with the following values, to allow ",(0,r.jsx)(n.code,{children:"rucio"})," to access the db:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"host\trucio\t\trucio\t\t0.0.0.0/0\tmd5\n"})}),"\n",(0,r.jsx)(n.h3,{id:"bootstrapping-the-database",children:"Bootstrapping the database"}),"\n",(0,r.jsx)(n.p,{children:"To bootstrap the db, there are two possibilities:"}),"\n",(0,r.jsxs)(n.h4,{id:"1-the-rucio-db-init-container",children:["1. The ",(0,r.jsx)(n.a,{href:"https://github.com/rucio/containers/tree/master/init",children:"Rucio DB init container"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'docker run --rm \\\n  -e RUCIO_CFG_DATABASE_DEFAULT="postgresql://rucio:xxx@dbod-rucioitdb.cern.ch:<port>/rucio" \\\n  -e RUCIO_CFG_BOOTSTRAP_USERPASS_IDENTITY="admin" \\\n  -e RUCIO_CFG_BOOTSTRAP_USERPASS_PWD="xxx" \\\n  rucio/rucio-init\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This command will setup all the necessary tables in the db, and additionally will create a rucio admin user. The admin user will be used when setting up rucio. ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"Please take note of the username and passw."})})]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["Notice the syntax of ",(0,r.jsx)(n.code,{children:'RUCIO_CFG_DATABASE_DEFAULT="postgresql://<db-user>:<passw>@<dbod-url>:<dobd-port>/<db-name>"'})]})}),"\n",(0,r.jsx)(n.h4,{id:"2-the-bootstrapping-pod",children:"2. The bootstrapping pod"}),"\n",(0,r.jsxs)(n.p,{children:["Create a ",(0,r.jsx)(n.code,{children:"init-pod.yaml"})," file and apply it as specified in the readme of the ",(0,r.jsx)(n.a,{href:"https://github.com/rucio/k8s-tutorial/blob/master/README.md",children:"k8s_tutorial"}),", replace ",(0,r.jsx)(n.code,{children:"<PASSWORD>"})," with the secret needed to connect to the database:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: init\n  labels:\n    app: rucio\nspec:\n  restartPolicy: Never\n  containers:\n    - name: init\n      image: rucio/rucio-init:latest\n      imagePullPolicy: Always\n      env:\n        - name: RUCIO_CFG_DATABASE_DEFAULT\n          value: postgresql://rucio:<PASSWORD>@postgres-postgresql/rucio\n        - name: RUCIO_CFG_DATABASE_SCHEMA\n          value: test\n        - name: RUCIO_CFG_BOOTSTRAP_USERPASS_IDENTITY\n          value: admin\n        - name: RUCIO_CFG_BOOTSTRAP_USERPASS_PWD\n          value: xxx\n        - name: RUCIO_PRINT_CFG\n          value: "true"\n'})}),"\n",(0,r.jsx)(n.p,{children:"And then apply the pod config:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kubectl apply -f init-pod.yaml\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Please notice that in this case, the various credentials will have to be properly stored as secrets. See the Managing Secrets section for more information."})}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-landb-set",children:"Creating a LanDB set"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["In order to ",(0,r.jsx)(n.a,{href:"https://security.web.cern.ch/services/en/firewall.shtml",children:"protect devices connected to the CERN network"})," from the regular attacks initiated from off-site, ",(0,r.jsx)(n.strong,{children:"incoming connections to all CERN devices are blocked"})," in the CERN outer perimeter firewall by default. In addition, source ports ",(0,r.jsx)(n.strong,{children:"0-1023/TCP and 0-1023/UDP (except 500/UDP) are blocked by default"})," for outgoing connections. Thus, users can initiate client applications (on so-called higher ports) but not expose server processes."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"To comply with the CERN security rules, we need to use the so-called LANDB sets, where the firewall has static openings automatically set up. Usually, such sets are used for redudancy or large, homogeneous services. These sets are either managed by the Computer Security Team or by the service managers themselves."}),"\n",(0,r.jsxs)(n.p,{children:["Create a ",(0,r.jsx)(n.a,{href:"https://landb.cern.ch/portal/sets/create",children:"new LanDB set"}),", following the recommendations:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Type: Interdomain"}),"\n",(0,r.jsx)(n.li,{children:"Network Domain: GPN"}),"\n",(0,r.jsxs)(n.li,{children:["Responsible: ",(0,r.jsx)(n.code,{children:"<your-egroup>"})]}),"\n",(0,r.jsx)(n.li,{children:"Description: use the following fields:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"OPENSTACK_PROJECT=cc059d57-6e98-4688-a3be-aae2b451868b,<your-openstack-project-ID>\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"LoadBalancer tip",type:"tip",children:(0,r.jsxs)(n.p,{children:["The ID ",(0,r.jsx)(n.code,{children:"cc059d57-6e98-4688-a3be-aae2b451868b"})," will allow the LoadBalancer as a Service (LBaaS) instance to ",(0,r.jsx)(n.a,{href:"https://clouddocs.web.cern.ch/networking/load_balancing.html#adding-load-balancer-to-landb-sets",children:"assign LoadBalancers to this set"}),". In the specific case of the COMPASS rucio instance, the ",(0,r.jsx)(n.code,{children:"openstack-landb-set-access"})," is being set as a member of the ",(0,r.jsx)(n.code,{children:"rucio-it-admins"})," egroup.\nPlease refer to the LoadBalancers section for more information."]})}),"\n",(0,r.jsx)(n.p,{children:"![[/img/landb-set-create.png]]"}),"\n",(0,r.jsx)(n.h1,{id:"populating-the-cluster",children:"Populating the cluster"}),"\n",(0,r.jsx)(n.p,{children:"There are four main components that need to be installed in order to have the Rucio cluster operative:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Rucio Servers"}),"\n",(0,r.jsx)(n.li,{children:"Rucio Authentication"}),"\n",(0,r.jsx)(n.li,{children:"Rucio Daemons"}),"\n",(0,r.jsx)(n.li,{children:"Rucio Web UI"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The following sections are based on the deployment of the ",(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass",children:"COMPASS Rucio instance"}),", within the CERN infrastructure."]}),"\n",(0,r.jsx)(n.h2,{id:"managing-secrets",children:"Managing secrets"}),"\n",(0,r.jsx)(n.h3,{id:"sealed-secrets",children:"Sealed-Secrets"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/bitnami-labs/sealed-secrets?tab=readme-ov-file#installation",children:"Reference Documentation"}),".\n",(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/sync/sealed-secrets.yaml?ref_type=heads",children:"Reference Helm chart"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"A very efficient way of managing secrets in the cluster is Bitnami's Sealed-Secrets. Install the Helm chart by executing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets\nrucio-helm-repo.yaml sealed-secrets.yaml\n\nkubectl create namespace sealed-secrets\n\nkubectl apply -f sealed-secrets.yaml \n"})}),"\n",(0,r.jsxs)(n.p,{children:["An example of the ",(0,r.jsx)(n.code,{children:"sealed-secrets.yaml"})," configuration file is provided below:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:"sealed-secrets.yaml",children:'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: sealed-secrets\n  labels:\n    name: sealed-secrets\n---\napiVersion: source.toolkit.fluxcd.io/v1beta1\nkind: HelmRepository\nmetadata:\n  name: sealed-secrets\n  namespace: sealed-secrets\nspec:\n  interval: 5m\n  url: https://bitnami-labs.github.io/sealed-secrets\n---\napiVersion: helm.toolkit.fluxcd.io/v2beta1\nkind: HelmRelease \nmetadata:\n  name: sealed-secrets\n  namespace: sealed-secrets\nspec:\n  releaseName: sealed-secrets\n  interval: 5m\n  chart:\n    spec:\n      sourceRef:\n        kind: HelmRepository\n        name: sealed-secrets\n        namespace: sealed-secrets\n      chart: sealed-secrets\n      interval: 5m\n      version: 2.15.3\n  values:\n    fullnameOverride: "sealed-secrets-controller"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Notice that ",(0,r.jsx)(n.code,{children:"yaml"})," files can be concatenated thanks to the ",(0,r.jsx)(n.code,{children:"---"})," separator."]}),"\n",(0,r.jsx)(n.h3,{id:"creating-secrets-for-the-cluster",children:"Creating secrets for the cluster"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/scripts?ref_type=heads",children:"Reference secrets generation scripts"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The creation of secrets can be based on the following process:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'#!/bin/bash\n\nHELM_RELEASE="rucio-servers"\nRAW_SECRETS_SERVERS="/root/compass-rucio-certs/servers"\n# kubeseal controller namespace\nCONTROLLER_NS="sealed-secrets"\nCONTROLLER_NAME="sealed-secrets-controller" # This can be checked in k8s/Services\n\n# rucio namespace\nRUCIO_NS="rucio"\n\n# Output dir\nSECRETS_STORE="/root/flux-compass/SECRETS/"\n\n\n# name of output secret to apply\nOUTPUT_SECRET="ruciocompass-db.yaml"\n\nkubectl create secret generic ${HELM_RELEASE}-server-hostcert --dry-run=client --from-file=${RAW_SECRETS_SERVERS}/hostcert.pem -o yaml | \\\nkubeseal --controller-name=${CONTROLLER_NAME} --controller-namespace=${CONTROLLER_NS} --format yaml --namespace=${RUCIO_NS} > ${SECRETS_STORE}/ss_${OUTPUT_SECRET}\n\nkubectl apply -f ${SECRETS_STORE}/ss_${OUTPUT_SECRET}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Where:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"HELM_RELEASE"})," is the name of the helm release that is being used."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"RAW_SECRETS_SERVERS"})," is the path in which the files that will be used as secrets are stored"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CONTROLLER_NS"})," is the namespace assigned to the secrets manager."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CONTROLLER_NAME"})," is the name of the secrets manager controller."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"RUCIO_NS"})," is the namespace related to Rucio (in the COMPASS case, it is called ",(0,r.jsx)(n.code,{children:"rucio"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SECRETS_STORE"})," path to which the files containing the encrypted secrets will be stored. These files will be used by flux."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"kubectl create secret generic"})," Creates a secret from the specific file that needs to be transposed to a secret."]}),"\n",(0,r.jsxs)(n.p,{children:["Then ",(0,r.jsx)(n.code,{children:"kubeseal"})," perform the encryption and the encoding, saving the secret to a file stored in ",(0,r.jsx)(n.code,{children:"SECRETS_STORE"}),".\nFinally, ",(0,r.jsx)(n.code,{children:"kubectl apply"})," applies the secret to the cluster. Please notice that this is eventually also achieved via flux, by pushing the secret file to the repository."]}),"\n",(0,r.jsxs)(n.admonition,{title:"Secret tip",type:"tip",children:[(0,r.jsxs)(n.p,{children:["IF ",(0,r.jsx)(n.code,{children:"kubeseal"})," returns an error, it's probably because it's not installed:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.18.0/kubeseal-0.18.0-linux-amd64.tar.gz\ntar xfz kubeseal-0.18.0-linux-amd64.tar.gz\nsudo install -m 755 kubeseal /usr/local/bin/kubeseal\n"})}),(0,r.jsx)(n.p,{children:"Adjust the version and the build details according to your machine."})]}),"\n",(0,r.jsx)(n.p,{children:"The content of the secret will be of this type:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:"ss_rucio-servers-hostcert.yaml",children:"apiVersion: bitnami.com/v1alpha1\nkind: SealedSecret\nmetadata:\n  creationTimestamp: null\n  name: rucio-servers-hostcert\n  namespace: rucio\nspec:\n  encryptedData:\n    hostcert.pem: <encrypted secret>\n  template:\n    data: null\n    metadata:\n      creationTimestamp: null\n      name: rucio-servers-hostcert\n      namespace: rucio\n"})}),"\n",(0,r.jsx)(n.h2,{id:"rucio-servers",children:"Rucio Servers"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"The Rucio servers are the backbone of the Rucio system. They handle all core functionalities including data management, rule-based data replication, data placement, and monitoring. The servers ensure the integrity and availability of data across various storage systems."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"In order to setup this service, four steps are needed:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Produce the Helm chart."}),"\n",(0,r.jsx)(n.li,{children:"Setup the LoadBalancers (LBs)."}),"\n",(0,r.jsxs)(n.li,{children:["Produce the certificates related to the ",(0,r.jsx)(n.code,{children:"landb-alias"})," used."]}),"\n",(0,r.jsx)(n.li,{children:"Add the certificates as secrets and mount them on the k8s pods."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"produce-the-helm-chart",children:"Produce the Helm chart"}),"\n",(0,r.jsxs)(n.p,{children:["Please look at the ",(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/sync/rucio-servers.yaml?ref_type=heads",children:"currently used one"}),".\nA few remarks:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The db secret is being mounted on ",(0,r.jsx)(n.code,{children:"config.database.default"})," in order to allow the user to correctly access it."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"hostcert.pem"}),", ",(0,r.jsx)(n.code,{children:"hostkey.pem"})," and ",(0,r.jsx)(n.code,{children:"ca.pem"})," are automatically detected, so they don't need to be mounted. Nevertheless, the corresponding secrets must be created (see next sections)."]}),"\n",(0,r.jsxs)(n.li,{children:["The GridCA cert is needed to verify all the other certs. Please look at this ",(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/commit/688da7285833dafd1bbe25469f35c6059d7af24f",children:"git commit"})," used to set the ",(0,r.jsx)(n.code,{children:"GridCA"})," file in ",(0,r.jsx)(n.code,{children:"/etc/grid-security/certificate"}),".","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Together with this, is also necessary to setup the correspoding variable ",(0,r.jsx)(n.code,{children:"RUCIO_CA_PATH"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"RUCIO_SSL_PROTOCOL"})," variable must be explicitly set."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Please notice that in order to have LBs produced, ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"the Helm chart must be applied"})}),".\nThis will come with several errors related to certificates, that will be fixed in the next steps."]}),"\n",(0,r.jsx)(n.h3,{id:"setup-the-lb",children:"Setup the LB"}),"\n",(0,r.jsx)(n.p,{children:"The minimal configuration for LoadBalancers is the following:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"    service:\n      type: LoadBalancer\n      port: 443\n      targetPort: 443\n      protocol: TCP\n      name: https\n"})}),"\n",(0,r.jsxs)(n.p,{children:["With respect to the ",(0,r.jsx)(n.a,{href:"https://github.com/rucio/helm-charts/blob/7f8a7d9fb9cbcd01d645f24523a173c7f53fb101/charts/rucio-server/values.yaml#L33",children:"original Helm chart"}),", that employs the Kubernetes native ",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/cluster-ip-allocation/",children:(0,r.jsx)(n.code,{children:"ClusterIP"})})," service, this configuration exploits the CERN native LBaaS, and exposes it over HTTPS.\nThis setup will trigger the ",(0,r.jsx)(n.code,{children:"openstack-cloud-controller-manager"})," pod, and will automatically instantiate the requested LBs."]}),"\n",(0,r.jsx)(n.p,{children:"Please notice that in order to have LBs, one must request a quota change to the openstack project:\n![[/img/get-lbs.png]]"}),"\n",(0,r.jsx)(n.p,{children:"To check the status of the LBs, the CLI command can be used:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"openstack loadbalancer list\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then, a few attributes must be changed in order to obtain the necessary DNS:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'openstack loadbalancer set --tag landb-set="RUCIO-IT" <lb-ID>\nopenstack loadbalancer set --tag landb-alias="compass-rucio.cern.ch" <lb-ID>\nopenstack loadbalancer set --description="compass-rucio.cern.ch" <lb-ID>\nopenstack loadbalancer set --tag main-user="rucio-it-admins" <lb-ID>\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Now, the LB must be added to the LanDB set from the dashboard, under IP Addresses.\nTo do that, first retrieve the virtual IP address, ",(0,r.jsx)(n.code,{children:"vip_address"}),", of the LB:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:" openstack loadbalancer show <lb-ID> | grep vip_address\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then, retrieve the pointer to the LB, for instance:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"host <vip_address>\n222.xx.xxx.xxx.in-addr.arpa domain name pointer lbaas-xxx4a6c2-xxxx-xxxx-xxxx-59489ffd7xxx.cern.ch.\n"})}),"\n",(0,r.jsxs)(n.p,{children:["where ",(0,r.jsx)(n.code,{children:"lbaas-xxx4a6c2-xxxx-xxxx-xxxx-59489ffd7xxx.cern.ch"})," represents the hostname of the LB.\nFinally, add ",(0,r.jsx)(n.code,{children:"lbaas-...cern.ch"})," to the list of allowed IP addresses in the LanDB set dashboard. Either the hostname or the ",(0,r.jsx)(n.code,{children:"vip_address"})," used before can be used in the search bar."]}),"\n",(0,r.jsx)(n.h3,{id:"produce-the-certificates-related-to-the-landb-alias",children:"Produce the certificates related to the landb-alias"}),"\n",(0,r.jsxs)(n.p,{children:["Read the ",(0,r.jsx)(n.a,{href:"https://ca.cern.ch/ca/Help/?kbid=021002",children:"help page"})," about Grid Host certs"]}),"\n",(0,r.jsxs)(n.p,{children:["Then, request a cert using ",(0,r.jsx)(n.a,{href:"https://ca.cern.ch/ca/host/HostSelection.aspx?template=EE2Host&instructions=auto",children:"dedicated page"}),".\nIn the current example, a cert for ",(0,r.jsx)(n.code,{children:"compass-rucio.cern.ch"})," (corresponding to the LB ",(0,r.jsx)(n.code,{children:"landdb-alias"}),") was requested:"]}),"\n",(0,r.jsx)(n.admonition,{title:"Certs pro move",type:"tip",children:(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Create a ",(0,r.jsx)(n.a,{href:"https://ca.cern.ch/ca/host/Request.aspx?template=ee2host",children:"grid Host certificate"})," linked to both servers and auth domains. If you need, you can specify Subject Alternative Names (SANs) for your certificate, in DNS format in the SAN box. Then you'll have one cert to rule them all:\n![[/img/grid-host-certs.png]]"]}),"\n"]})}),"\n",(0,r.jsxs)(n.h4,{id:"create-the-host-key-ca-and-gridca-files",children:["Create the ",(0,r.jsx)(n.code,{children:"host"}),", ",(0,r.jsx)(n.code,{children:"key"}),", ",(0,r.jsx)(n.code,{children:"ca"})," and ",(0,r.jsx)(n.code,{children:"GridCA"})," files"]}),"\n",(0,r.jsxs)(n.p,{children:["As recommended in the ",(0,r.jsx)(n.a,{href:"https://ca.cern.ch/ca/Help/?kbid=024100",children:"documentation"}),", extract the certificate (which contains the public key) and the private key, using:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"openssl pkcs12 -in compass-rucio.p12 -clcerts -nokeys -out hostcert.pem\n\nopenssl pkcs12 -in compass-rucio.p12 -nocerts -nodes -out hostkey.pem\n\nchmod 400 hostkey.pem \nchmod 644 hostcert.pem \n"})}),"\n",(0,r.jsxs)(n.p,{children:["Notice that to avoid protecting the key with a passphrase, the ",(0,r.jsx)(n.code,{children:"-nodes"})," option is specified. Moreover, the appropriate permissions (",(0,r.jsx)(n.code,{children:"400"}),": read by owner, ",(0,r.jsx)(n.code,{children:"644"}),": read by anyone, written by owner) for the extracted files are set."]}),"\n",(0,r.jsxs)(n.p,{children:["These files have to be stored in the same path as described by the ",(0,r.jsx)(n.code,{children:"RAW_SECRETS_SERVERS"})," variable used in the secrets creation."]}),"\n",(0,r.jsxs)(n.h5,{id:"important-information-about-capem-and-gridcapem",children:["Important information about ",(0,r.jsx)(n.code,{children:"ca.pem"})," and ",(0,r.jsx)(n.code,{children:"GridCA.pem"})]}),"\n",(0,r.jsxs)(n.p,{children:["An additional file, ",(0,r.jsx)(n.code,{children:"ca.pem"})," (i.e. ",(0,r.jsx)(n.code,{children:"CERN-bundle.pem"}),") must be created."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"CERN-bundle.pem"})," is a standard CA bundle provided by CERN, containing multiple CA certificates that CERN trusts. This file is used to verify the authenticity of other certificates within a secure communication process (e.g., SSL/TLS)."]}),"\n",(0,r.jsx)(n.p,{children:"This file can be retrieved from lxplus:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cp /etc/pki/tls/certs/CERN-bundle.pem compass-rucio-certs/servers/ca.pem\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The same goes for the ",(0,r.jsx)(n.code,{children:"GridCA.pem"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cp /etc/grid-security/certificates/CERN-GridCA.pem compass-rucio-certs/servers/GridCA.pem\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This file is used for the Certification Authority issuing SHA-2 certificates for Grid usage (user, host and robot certificates), in compliance with ",(0,r.jsx)(n.a,{href:"https://www.eugridpma.org/",children:"EUGridPMA"})," policies."]}),"\n",(0,r.jsx)(n.h3,{id:"add-the-certificates-as-secrets-and-mount-them-on-the-k8s-pods",children:"Add the certificates as secrets and mount them on the k8s pods"}),"\n",(0,r.jsxs)(n.p,{children:["Now it is possible to run something similar to the ",(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/scripts/rucio-servers-secret.sh?ref_type=heads",children:"servers script"})," to add all the secrets to the cluster."]}),"\n",(0,r.jsx)(n.p,{children:"The output should be of this form:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"Create and apply SERVER secrets\nsealedsecret.bitnami.com/rucio-servers-server-hostcert configured\nsealedsecret.bitnami.com/rucio-servers-server-hostkey configured\nsealedsecret.bitnami.com/rucio-servers-server-cafile configured\n.\n.\n.\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The flux sync can be triggered by ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"git pushing"})})," the content of the ",(0,r.jsx)(n.code,{children:"SECRET"})," folder to the remote repository."]}),"\n",(0,r.jsx)(n.h2,{id:"rucio-auth",children:"Rucio Auth"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/sync/rucio-servers-auth.yaml?ref_type=heads",children:"Reference Helm chart"}),"."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"The authentication component of Rucio is responsible for securely verifying the identities of users and services attempting to access the Rucio system. It ensures that only authorised entities can perform actions within the system."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"As for the servers, four steps are needed to deploy the authentication pod:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Produce the Helm chart."}),"\n",(0,r.jsx)(n.li,{children:"Setup the LB."}),"\n",(0,r.jsxs)(n.li,{children:["Produce the certificates related to the ",(0,r.jsx)(n.code,{children:"landb-alias"})," used."]}),"\n",(0,r.jsx)(n.li,{children:"Add the certificates as secrets and mount them on the k8s pods."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Based on the reference Helm chart, we can add a few remarks:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Explicitly mounting secrets for ",(0,r.jsx)(n.code,{children:"hostcert"}),", ",(0,r.jsx)(n.code,{children:"hostkey"}),", and ",(0,r.jsx)(n.code,{children:"ca"}),", via ",(0,r.jsx)(n.code,{children:"secretMounts"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"httpd"})," configuration block:\nthis block maps the certificate to an account name.\nSetting up ",(0,r.jsx)(n.code,{children:"x509"})," auth can be very tricky, please make sure that the ",(0,r.jsx)(n.a,{href:"https://github.com/rucio/containers/blob/b51bbceb5aab0a1e07d48845f295cbbb175bdcb9/server/rucio.conf.j2#L104",children:(0,r.jsx)(n.code,{children:"grid_site_enabled"})})," parameter is set on ",(0,r.jsx)(n.code,{children:"True"}),". ",(0,r.jsx)("br",{}),"\nThis enables the ",(0,r.jsx)(n.code,{children:"auth/x509_proxy"})," endpoint! ",(0,r.jsx)("br",{}),"\nThe endpoint can be tested by executing","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"curl -k https://compass-rucio.cern.ch/auth/x509_proxy\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Another important change is related to the LB attributes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'openstack loadbalancer set --tag landb-set="RUCIO-IT" <lb-ID>\nopenstack loadbalancer set --tag landb-alias="compass-rucio-auth.cern.ch" <lb-ID>\nopenstack loadbalancer set --description="compass-rucio-auth.cern.ch" <lb-ID>\nopenstack loadbalancer set --tag main-user="rucio-it-admins" <lb-ID>\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Here, the ",(0,r.jsx)(n.code,{children:"landb-alias"})," attribute and the ",(0,r.jsx)(n.code,{children:"description"})," have been changed with respect to servers. The choice of the alias must comply with the naming used while creating the host certificates."]}),"\n",(0,r.jsx)(n.h2,{id:"rucio-daemons",children:"Rucio Daemons"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/sync/rucio-daemons.yaml?ref_type=heads",children:"Reference Helm chart"}),".",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.a,{href:"/documentation/operator/installing_daemons",children:"Reference installation guide"}),"."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Daemons in Rucio are background processes that perform various maintenance and operational tasks. They ensure that the system operates smoothly and that data management policies are enforced continuously."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The description of the various daemons can be found in ",(0,r.jsx)(n.a,{href:"https://rucio.github.io/documentation/bin/rucio-abacus-account",children:"here"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"fts-renewal-and-delegation",children:"FTS renewal and delegation"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://cs3mesh4eosc.eu/technologies/file-transfer-service-fts",children:"FTS"})," is an open source software for reliable and large-scale data transfers. It provides easy user interfaces for submitting transfers: Python CLI, Python Client, WebFTS and Web Monitoring. Checksums and retries are provided per transfer and it is a flexible tool due to its multiprotocol support (Webdav/https, GridFTP, xroot, SRM). It also allows parallel transfers optimization to get the most from network without burning the storages."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"how-does-fts-work-users-x509-certs",children:"How does FTS work: users' x509 certs"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Users will have to pass their own x509 cert by setting its path in their rucio config."}),"\n",(0,r.jsx)(n.li,{children:"Then, the x509 is used to map the cert to an identity that must be created within rucio, which corresponds to a user."}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"how-does-fts-work-service-x509-cert",children:"How does FTS work: service x509 cert"}),"\n",(0,r.jsxs)(n.p,{children:["It is not the user's account that uploads, downloads, etc, but it's a ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"service account"})})," that is set up normally by the collaboration or the team."]}),"\n",(0,r.jsxs)(n.p,{children:["Together with the service account, we also need the corresponding user ",(0,r.jsx)("u",{children:"grid cert"})," that is split in ",(0,r.jsx)(n.code,{children:"cert"})," and ",(0,r.jsx)(n.code,{children:"key"})," and is passed to the ",(0,r.jsx)(n.code,{children:"ftsRenewal"})," daemon, that renews it periodically through a ",(0,r.jsx)(n.a,{href:"https://github.com/rucio/containers/blob/master/fts-cron/renew_fts_proxy.sh.j2",children:"specific script"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- secretName: fts-cert\n  mountPath: /opt/rucio/certs/\n- secretName: fts-key\n  mountPath: /opt/rucio/keys/\n"})}),"\n",(0,r.jsx)(n.h4,{id:"how-to-connect-to-the-proper-vo",children:"How to connect to the proper VO?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/documentation/operator/multi_vo_rucio",children:"Reference documentation"}),"."]}),"\n",(0,r.jsx)(n.admonition,{title:"VO vs VOMS",type:"tip",children:(0,r.jsx)(n.p,{children:"The VOMS (Virtual Organization Membership Service) is an attribute authority which serves as central repository for VO (Virtual Organization) user authorization information"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Specify which VO to use; in our case is ",(0,r.jsx)(n.code,{children:"vo.compass.cern.ch"})]}),"\n",(0,r.jsxs)(n.li,{children:["If not present, create a config file for the VOMS in ",(0,r.jsx)(n.code,{children:"/etc/vomses"}),".\nIn our case, looking at lxplus we have a file named ",(0,r.jsx)(n.code,{children:"vo.compass.cern.ch-voms-compass-auth.cern.ch"})," that contains"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'"vo.compass.cern.ch" "voms-compass-auth.cern.ch" "443" "/DC=ch/DC=cern/OU=computers/CN=compass-auth.cern.ch" "vo.compass.cern.ch" "24"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["So we need to create a secret with the proper content and ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"mount"})})," it in the ",(0,r.jsx)(n.code,{children:"ftsRenewal"})," daemon, under ",(0,r.jsx)(n.code,{children:"/etc/vomses"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- secretName: voms-compass\n  mountPath: /etc/vomses/\n"})}),"\n",(0,r.jsx)(n.p,{children:"In this way, we'll get something like the following output from the cron-job:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'renew-fts-proxy: =================== Delegating ========================    \nrenew-fts-proxy:  Proxy certificate file : /tmp/x509up\nrenew-fts-proxy:  User certificate file: /tmp/cert.pem\nrenew-fts-proxy:  User key file: /tmp/key.pem         \nrenew-fts-proxy: Output to /tmp/x509up  \nrenew-fts-proxy: Enter GRID pass phrase:\nrenew-fts-proxy: Your identity: /DC=ch/DC=cern/OU=Organic Units/OU=Users/CN=na58dst1/CN=698253/CN=Robot: compass production \nrenew-fts-proxy: Using configuration file /root/.glite/vomses       \nrenew-fts-proxy: Using configuration file /etc/vomses \nrenew-fts-proxy: .........+++           \nrenew-fts-proxy: ....................+++\nrenew-fts-proxy: Creating temporary proxy to /tmp/tmp_x509up_u0_317  Done \nrenew-fts-proxy: Contacting  voms-compass-auth.cern.ch:443 [/DC=ch/DC=cern/OU=computers/CN=compass-auth.cern.ch] "vo.compass.cern.ch" Done   \n\nrenew-fts-proxy: Warning: WARNING: vo.compass.cern.ch : The validity period of the issued attributes has been shortened to the maximum allowed by this VOMS server\n\nrenew-fts-proxy: Creating proxy to /tmp/x509up        \nrenew-fts-proxy: No policy language specified, Gsi impersonation proxy assumed. Done            \n       \nrenew-fts-proxy: Your proxy is valid until Fri May 31 15:49:15 2024 \nrenew-fts-proxy: Error: verification failed.          \n         \nrenew-fts-proxy: User certificate: /tmp/x509up        \nrenew-fts-proxy: User private key: /tmp/x509up        \nrenew-fts-proxy: Loaded DC=ch, DC=cern, OU=Organic Units, OU=Users, CN=na58dst1, CN=698253, CN=Robot: compass production, CN=2643790443   \nrenew-fts-proxy: Loaded DC=ch, DC=cern, OU=Organic Units, OU=Users, CN=na58dst1, CN=698253, CN=Robot: compass production    \nrenew-fts-proxy: Using endpoint: https://fts3-pilot.cern.ch:8446    \nrenew-fts-proxy: REST API version: 3.13.0             \nrenew-fts-proxy: Delegation ID: ef1e8a8e094bde07      \nrenew-fts-proxy: No previous delegation found         \nrenew-fts-proxy: Delegating             \nrenew-fts-proxy: Signing request        \nrenew-fts-proxy: Delegation id: ef1e8a8e094bde07      \nrenew-fts-proxy: Termination time: 2024-05-31T15:49:15 \n'})}),"\n",(0,r.jsx)(n.h3,{id:"additional-environment-variables",children:"Additional environment variables"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"additionalEnvs:\n  - name: USERCERT_NAME\n    value: na58dst1.usercert.pem\n  - name: USERKEY_NAME\n    value: na58dst1.userkey.pem\n  - name: RUCIO_FTS_SECRETS\n    value: rucio-daemons-rucio-x509up\n  - name: GRID_PASSPHRASE\n    valueFrom:\n    secretKeyRef:\n      name: rucio-daemons-fts-passphrase\n      key: passphrase\n"})}),"\n",(0,r.jsx)(n.p,{children:"A diagram of how the proxy certificate is created and mounted on the daemons is displayed below:"}),"\n",(0,r.jsx)(n.p,{children:"![[/img/daemons-chart.png]]"}),"\n",(0,r.jsx)(n.h2,{id:"rucio-ui",children:"Rucio UI"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/blob/master/sync/rucio-ui.yaml?ref_type=heads",children:"Reference Helm Chart"}),"."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"The Rucio User Interface (UI) provides an accessible way for users to interact with the Rucio system. It allows users to manage data, set replication rules, and monitor data transfers and storage through a graphical or command-line interface."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"As for Servers and Authentication, it is necessary to get the following components running:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Dedicated LB: in the example, the domain associated with it is ",(0,r.jsx)(n.code,{children:"compass-rucio-ui.cern.ch"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["This value will be used in the ",(0,r.jsx)(n.code,{children:"httpd"})," block:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'rucio_hostname: "compass-rucio-ui.cern.ch"\n'})}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Grid Host certificates for the domain."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The secrets are then mounted in the following block:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"secretMounts:\n  - secretName: hostcert\n  mountPath: /etc/grid-security/hostcert.pem\n  subPath: hostcert.pem\n  - secretName: hostkey\n  mountPath: /etc/grid-security/hostkey.pem\n  subPath: hostkey.pem\n  - secretName: cafile\n  mountPath: /etc/grid-security/ca.pem\n  subPath: ca.pem\n"})}),"\n",(0,r.jsx)(n.h3,{id:"proxy-block",children:"Proxy block"}),"\n",(0,r.jsx)(n.p,{children:"These settings configure how the Rucio UI will connect to the main Rucio service and the authentication service through specified proxies."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'proxy:\n  rucioProxy: "compass-rucio.cern.ch"\n  rucioAuthProxy: "compass-rucio-auth.cern.ch"\n  rucioAuthProxyScheme: "https"\n'})}),"\n",(0,r.jsx)(n.h1,{id:"setting-up-rucio",children:"Setting up Rucio"}),"\n",(0,r.jsxs)(n.h2,{id:"installing-rucio-clients",children:["Installing ",(0,r.jsx)(n.code,{children:"rucio-clients"})]}),"\n",(0,r.jsx)(n.p,{children:"Please refer to the [installation page]."}),"\n",(0,r.jsx)(n.admonition,{title:"TL;DR",type:"info",children:(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"pip install rucio-clients"})})}),"\n",(0,r.jsxs)(n.h3,{id:"installing-gfal",children:["Installing ",(0,r.jsx)(n.code,{children:"gfal"})]}),"\n",(0,r.jsxs)(n.admonition,{title:"Remember to install dependencies",type:"tip",children:[(0,r.jsxs)(n.p,{children:["Install ",(0,r.jsx)(n.code,{children:"gfal2"}),' "properly":\n',(0,r.jsx)(n.a,{href:"https://dmc-docs.web.cern.ch/dmc-docs/gfal2-python/pip-install.html",children:"https://dmc-docs.web.cern.ch/dmc-docs/gfal2-python/pip-install.html"}),"\nAND install these plugins:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:" sudo dnf install gfal2-plugin-srm\n sudo dnf install gfal2-plugin-xrootd\n sudo dnf install gfal2-plugin-mock\n sudo dnf install gfal2-plugin-file\n sudo dnf install gfal2-plugin-http\n"})})]}),"\n",(0,r.jsx)(n.h2,{id:"creating-the-rucio-root-account-configuration-file",children:"Creating the Rucio root account configuration file"}),"\n",(0,r.jsxs)(n.p,{children:["This is the minimal setup for the configuration file (",(0,r.jsx)(n.code,{children:"rucio.cfg"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"[client]\nrucio_host = https://compass-rucio.cern.ch\nauth_host = https://compass-rucio-auth.cern.ch\nca_cert = /etc/pki/tls/certs/CERN-bundle.pem\nauth_type = userpass\naccount = root\nusername = admin\npassword = xxx\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Where ",(0,r.jsx)(n.code,{children:"username"})," and ",(0,r.jsx)(n.code,{children:"password"})," are the ones created while bootstrapping the db."]}),"\n",(0,r.jsx)(n.p,{children:"To export the created configuration, execute:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"export RUCIO_CONFIG=<path-to>/rucio.cfg\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then test it via ",(0,r.jsx)(n.code,{children:"rucio whoami"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"optional-creating-a-rucio-client-user-pod-in-the-cluster",children:"Optional: creating a rucio client user pod in the cluster"}),"\n",(0,r.jsx)(n.p,{children:"Look at the following commits to have an example of how to create a pod in the cluster that serves as u rucio user:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/commit/7579ea6fee12609a419639d3a6390cf1f9f9ee63",children:"Creating a rucio client root account"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://gitlab.cern.ch/rucio-it/flux-compass/-/commit/7e3075f1161c5728ca7e7d485242e152975f8b7c",children:"Creating secrets"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Creating secrets for username, password, and cert bundle (that HAS to be the ",(0,r.jsx)(n.code,{children:"CERN-bundle.pem"})," that we find in ``/etc/pki/tls/certs/CERN-bundle.pem`)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["[!tip] How to I pass a cert to a pod?\nCreate a secret for the cert, and then mount the secret to a specific path, using ",(0,r.jsx)(n.code,{children:"volumeMounts"}),": take a look below"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'  volumes:\n    - name: cern-bundle\n      secret:\n        secretName: rucio-root-account-cern-bundle\n  containers:\n  - name: rucio-client\n    image: rucio/rucio-clients:release-34.0.0\n    volumeMounts:\n      - name: cern-bundle\n        mountPath: "/etc/pki/tls/certs/CERN-bundle.pem"\n        subPath: CERN-bundle.pem\n        readOnly: true\n'})}),"\n",(0,r.jsx)(n.h2,{id:"rucio-admin-usage",children:"Rucio admin usage"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://rucio.github.io/documentation/bin/rucio-admin",children:(0,r.jsx)(n.code,{children:"rucio-admin"})})," command can be used to setup the Rucio instance."]}),"\n",(0,r.jsx)(n.h3,{id:"create-the-rucio-storage-elements-rses",children:"Create the Rucio Storage Elements (RSEs)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio-admin rse add XRD1\nrucio-admin rse add XRD2\nrucio-admin rse add XRD3\n"})}),"\n",(0,r.jsx)(n.h3,{id:"add-the-protocol-definitions-for-the-storage-servers",children:"Add the protocol definitions for the storage servers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'rucio-admin rse add-protocol --hostname xrd1 --scheme root --prefix //rucio --port 1094 --impl rucio.rse.protocols.gfal.Default --domain-json \'{"wan": {"read": 1, "write": 1, "delete": 1, "third_party_copy_read": 1, "third_party_copy_write": 1}, "lan": {"read": 1, "write": 1, "delete": 1}}\' XRD1\nrucio-admin rse add-protocol --hostname xrd2 --scheme root --prefix //rucio --port 1094 --impl rucio.rse.protocols.gfal.Default --domain-json \'{"wan": {"read": 1, "write": 1, "delete": 1, "third_party_copy_read": 1, "third_party_copy_write": 1}, "lan": {"read": 1, "write": 1, "delete": 1}}\' XRD2\nrucio-admin rse add-protocol --hostname xrd3 --scheme root --prefix //rucio --port 1094 --impl rucio.rse.protocols.gfal.Default --domain-json \'{"wan": {"read": 1, "write": 1, "delete": 1, "third_party_copy_read": 1, "third_party_copy_write": 1}, "lan": {"read": 1, "write": 1, "delete": 1}}\' XRD3\n'})}),"\n",(0,r.jsx)(n.h3,{id:"enable-fts",children:"Enable FTS"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio-admin rse set-attribute --rse XRD1 --key fts --value https://fts:8446\nrucio-admin rse set-attribute --rse XRD2 --key fts --value https://fts:8446\nrucio-admin rse set-attribute --rse XRD3 --key fts --value https://fts:8446\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note that ",(0,r.jsx)(n.code,{children:"8446"})," is the port exposed by the ",(0,r.jsx)(n.code,{children:"fts-server"})," pod. You can easily view ports opened by a pod by ",(0,r.jsx)(n.code,{children:"kubectl describe pod PODNAME"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"fake-a-full-mesh-network",children:"Fake a full mesh network"}),"\n",(0,r.jsx)(n.p,{children:"This command will set the distance between RSEs to 1, in order to make transfers possible."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio-admin rse add-distance --distance 1 --ranking 1 XRD1 XRD2\nrucio-admin rse add-distance --distance 1 --ranking 1 XRD1 XRD3\nrucio-admin rse add-distance --distance 1 --ranking 1 XRD2 XRD1\nrucio-admin rse add-distance --distance 1 --ranking 1 XRD2 XRD3\nrucio-admin rse add-distance --distance 1 --ranking 1 XRD3 XRD1\nrucio-admin rse add-distance --distance 1 --ranking 1 XRD3 XRD2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"set-indefinite-storage-quota-for-root",children:"Set indefinite storage quota for root"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio-admin account set-limits root XRD1 -1\nrucio-admin account set-limits root XRD2 -1\nrucio-admin account set-limits root XRD3 -1\n"})}),"\n",(0,r.jsx)(n.h3,{id:"create-a-default-scope-for-testing",children:"Create a default scope for testing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio-admin scope add --account root --scope test\n"})}),"\n",(0,r.jsx)(n.h2,{id:"data-management",children:"Data management"}),"\n",(0,r.jsx)(n.h3,{id:"create-initial-transfer-testing-data",children:"Create initial transfer testing data"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"dd if=/dev/urandom of=file1 bs=10M count=1\ndd if=/dev/urandom of=file2 bs=10M count=1\ndd if=/dev/urandom of=file3 bs=10M count=1\ndd if=/dev/urandom of=file4 bs=10M count=1\n"})}),"\n",(0,r.jsx)(n.h3,{id:"upload-the-files",children:"Upload the files"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio upload --rse XRD1 --scope test file1\nrucio upload --rse XRD1 --scope test file2\nrucio upload --rse XRD2 --scope test file3\nrucio upload --rse XRD2 --scope test file4\n"})}),"\n",(0,r.jsx)(n.h3,{id:"create-a-few-datasets-and-containers",children:"Create a few datasets and containers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio add-dataset test:dataset1\nrucio attach test:dataset1 test:file1 test:file2\n\nrucio add-dataset test:dataset2\nrucio attach test:dataset2 test:file3 test:file4\n\nrucio add-container test:container\nrucio attach test:container test:dataset1 test:dataset2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"create-a-rule-and-remember-returned-rule-id",children:"Create a rule and remember returned rule ID"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"rucio add-rule test:container 1 XRD3\n"})}),"\n",(0,r.jsx)(n.p,{children:"Query the status of the rule until it is completed. Note that the daemons are running with long sleep cycles (e.g. 30 seconds, 60 seconds) by default, so this will take a bit. You can always watch the output of the daemon containers to see what they are doing."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio rule-info <rule_id>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For this command, get the ",(0,r.jsx)(n.code,{children:"rule_id"})," by,"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio list-rules test:container\n"})}),"\n",(0,r.jsx)(n.p,{children:"Add some more complications"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"rucio add-dataset test:dataset3\nrucio attach test:dataset3 test:file4\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var s=t(96540);const r={},i=s.createContext(r);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);